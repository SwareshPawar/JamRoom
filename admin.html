<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - JamSpace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#06B6D4',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .booking-card {
            transition: all 0.3s ease;
        }
        
        .booking-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <a href="index.html" class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center shadow-md">
                        <span class="text-white font-bold text-xl"><i class="fas fa-arrow-left"></i></span>
                    </a>
                    <span class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">JamSpace Admin</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="logoutBtn" class="bg-dark text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors shadow-md">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Error Banner -->
    <div id="errorBanner" class="hidden fixed top-16 left-0 right-0 bg-red-500 text-white text-center py-3 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <span id="errorMessage" class="font-medium flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span></span>
            </span>
            <button onclick="hideError()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-4">
        <h2 class="text-2xl font-bold text-dark mb-6">Admin Dashboard</h2>
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full mr-4">
                        <i class="fas fa-calendar-check text-white text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Total Bookings</p>
                        <h3 class="text-2xl font-bold" id="totalBookingsCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full mr-4">
                        <i class="fas fa-dollar-sign text-white text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Total Revenue</p>
                        <h3 class="text-2xl font-bold" id="totalRevenue">$0</h3>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full mr-4">
                        <i class="fas fa-users text-white text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">Active Users</p>
                        <h3 class="text-2xl font-bold" id="activeUsers">0</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="adminDashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Admin Controls -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Admin Controls</h3>
                    <div class="space-y-4">
                        <button id="blockDateBtn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors">Block Date</button>
                        <button id="setHoursBtn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">Set Available Hours</button>
                        <button id="viewRevenueBtn" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-colors">View Revenue</button>
                    </div>
                </div>
                <!-- All Bookings -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">All Bookings</h3>
                    <div id="reportDisplay" class="mb-4 hidden"></div>
                    <div id="adminBookings" class="space-y-3">
                        <!-- Admin bookings view will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block Date Modal -->
    <div id="blockDateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <div class="bg-red-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-ban text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-6 text-center text-dark">Block Date</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Date</label>
                    <input type="date" id="blockDateInput" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="flex space-x-4">
                    <button onclick="adminBlockDate(true)" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                        <i class="fas fa-ban mr-2"></i> Block
                    </button>
                    <button onclick="adminBlockDate(false)" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                        <i class="fas fa-check mr-2"></i> Unblock
                    </button>
                </div>
            </div>
            <button onclick="hideModal('blockDateModal')" class="mt-6 text-gray-500 hover:text-gray-700 w-full text-center">Cancel</button>
        </div>
    </div>

    <!-- Revenue Report Modal -->
    <div id="revenueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4">
            <div class="bg-green-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-6 text-center text-dark">Revenue Report</h2>
            <div class="flex space-x-4 mb-6">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="reportStartDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                    <input type="date" id="reportEndDate" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>
            <button onclick="generateReport()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center mb-4">
                <i class="fas fa-chart-bar mr-2"></i> Generate Report
            </button>
            <div id="reportResults" class="hidden">
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-lg mb-2">Report Results</h4>
                    <div id="reportData"></div>
                </div>
            </div>
            <button onclick="hideModal('revenueModal')" class="mt-4 text-gray-500 hover:text-gray-700 w-full text-center">Close</button>
        </div>
    </div>

    <script>
        // Application State for Admin Page
        let adminBookings = [];
        let adminStats = {
            totalBookings: 0,
            totalRevenue: 0,
            activeUsers: 0
        };

        // DOM Elements
        const elements = {
            totalBookingsCount: document.getElementById('totalBookingsCount'),
            totalRevenue: document.getElementById('totalRevenue'),
            activeUsers: document.getElementById('activeUsers'),
            adminBookings: document.getElementById('adminBookings'),
            blockDateBtn: document.getElementById('blockDateBtn'),
            setHoursBtn: document.getElementById('setHoursBtn'),
            viewRevenueBtn: document.getElementById('viewRevenueBtn'),
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Initialize Admin Application
        function initAdmin() {
            fetchAdminData();
            setupAdminEventListeners();
        }

        // Event Listeners
        function setupAdminEventListeners() {
            elements.blockDateBtn.addEventListener('click', showBlockDateModal);
            elements.setHoursBtn.addEventListener('click', showSetHoursModal);
            elements.viewRevenueBtn.addEventListener('click', showRevenueModal);
            elements.logoutBtn.addEventListener('click', logoutAdmin);
        }

        // Fetch Admin Data
        async function fetchAdminData() {
            await Promise.all([
                fetchAdminBookings(),
                fetchAdminStats()
            ]);
        }

        // Fetch Admin Bookings
        async function fetchAdminBookings() {
            const result = await safeFetch('/api/admin/bookings');
            if (result.success) {
                adminBookings = result.bookings;
                renderAdminBookings();
            } else {
                showError('Failed to fetch bookings: ' + result.error);
            }
        }

        // Fetch Admin Stats
        async function fetchAdminStats() {
            const result = await safeFetch('/api/admin/revenue');
            if (result.success) {
                adminStats.totalBookings = result.totalBookings;
                adminStats.totalRevenue = result.totalRevenue;
                // For active users, we might need a different endpoint
                updateAdminStats();
            } else {
                showError('Failed to fetch stats: ' + result.error);
            }
        }

        // Update Admin Stats UI
        function updateAdminStats() {
            elements.totalBookingsCount.textContent = adminStats.totalBookings;
            elements.totalRevenue.textContent = '$' + adminStats.totalRevenue;
            elements.activeUsers.textContent = adminStats.activeUsers;
        }

        // Render Admin Bookings
        function renderAdminBookings() {
            if (adminBookings.length === 0) {
                elements.adminBookings.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-4 text-gray-400"></i>
                        <p>No bookings to display.</p>
                    </div>
                `;
                return;
            }

            let bookingsHTML = '';
            adminBookings.forEach(booking => {
                bookingsHTML += `
                    <div class="booking-card bg-gray-50 p-4 rounded-lg border">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-dark">${booking.bandName}</h4>
                                <p class="text-sm text-gray-600">${booking.email}</p>
                                <p class="text-gray-600">${new Date(booking.date).toLocaleDateString()} at ${booking.startTime}</p>
                                <p class="text-gray-600">${booking.duration} hours - $${booking.price}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                    ${booking.status}
                                </span>
                                <button class="block mt-2 text-red-600 hover:text-red-800 text-sm" onclick="cancelBooking('${booking._id}')">
                                    <i class="fas fa-times mr-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            elements.adminBookings.innerHTML = bookingsHTML;
        }

        // Admin Functions
        function showBlockDateModal() {
            showModal('blockDateModal');
        }

        function showSetHoursModal() {
            alert('Slot management feature coming soon!');
        }

        function showRevenueModal() {
            // Set default dates
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            
            showModal('revenueModal');
        }

        async function adminBlockDate(shouldBlock) {
            const date = document.getElementById('blockDateInput').value;
            if (!date) {
                showError('Please select a date');
                return;
            }
            
            const result = await safeFetch('/api/admin/block-date', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, isBlocked: shouldBlock })
            });
            
            if (result.success) {
                showError(`Date ${date} ${shouldBlock ? 'blocked' : 'unblocked'} successfully`, 3000);
                hideModal('blockDateModal');
            } else {
                showError('Error: ' + result.error);
            }
        }

        async function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showError('Please select both start and end dates');
                return;
            }
            
            const result = await safeFetch(`/api/admin/revenue?startDate=${startDate}&endDate=${endDate}`);
            if (result.success) {
                const reportHTML = `
                    <div class="space-y-2">
                        <p><strong>Total Revenue:</strong> $${result.totalRevenue}</p>
                        <p><strong>Total Bookings:</strong> ${result.totalBookings}</p>
                        <p><strong>Average Booking Value:</strong> $${result.averageBookingValue.toFixed(2)}</p>
                    </div>
                    <h4 class="font-semibold mt-4 mb-2">Busiest Time Slots:</h4>
                    <div class="space-y-2">
                        ${result.busySlots.map(slot => `
                            <p>${slot._id.date} at ${slot._id.time}: ${slot.count} bookings ($${slot.totalRevenue})</p>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('reportData').innerHTML = reportHTML;
                document.getElementById('reportResults').classList.remove('hidden');
            } else {
                showError('Error generating report: ' + result.error);
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            
            const result = await safeFetch(`/api/bookings/${bookingId}`, {
                method: 'DELETE'
            });
            
            if (result.success) {
                showError('Booking cancelled successfully', 3000);
                fetchAdminData(); // Refresh data
            } else {
                showError('Error cancelling booking: ' + result.error);
            }
        }

        function logoutAdmin() {
            window.location.href = 'index.html';
        }

        // Helper Functions
        const BACKEND_URL = 'http://127.0.0.1:5000';
        async function safeFetch(url, options) {
            try {
                const res = await fetch(BACKEND_URL + url, options);
                if (!res.ok) {
                    // Try to get error message from response
                    let errorMsg = 'Server error';
                    try {
                        const errorData = await res.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        errorMsg = `HTTP ${res.status} ${res.statusText}`;
                    }
                    throw new Error(errorMsg);
                }
                return await res.json();
            } catch (err) {
                console.error('Fetch error:', err);
                showError(err.message || 'Backend is not available. Please try again later.');
                return { success: false, error: err.message };
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showError(message, duration = 5000) {
            const errorBanner = document.getElementById('errorBanner');
            const errorMessage = document.getElementById('errorMessage').querySelector('span');
            
            errorMessage.textContent = message;
            errorBanner.classList.remove('hidden');
            
            // Auto-hide after duration
            if (duration > 0) {
                setTimeout(() => {
                    hideError();
                }, duration);
            }
        }

        function hideError() {
            const errorBanner = document.getElementById('errorBanner');
            errorBanner.classList.add('hidden');
        }

        // Make functions available globally
        window.adminBlockDate = adminBlockDate;
        window.generateReport = generateReport;
        window.cancelBooking = cancelBooking;
        window.hideModal = hideModal;
        window.hideError = hideError;

        // Initialize the admin application
        initAdmin();
    </script>
</body>
</html>