<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JamRoom - Client PDF Test (Working Version)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #667eea;
            font-size: 16px;
            font-weight: 500;
        }
        
        .test-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid #667eea;
        }
        
        .test-section h3 {
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 12px;
            margin-bottom: 12px;
        }
        
        .test-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .test-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-weight: 500;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: 500;
            margin: 20px 0;
        }
        
        .loading.show {
            display: block;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 16px 0;
        }
        
        .data-preview {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-size: 12px;
            color: #4a5568;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .highlight-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .highlight-box p {
            margin: 0;
            font-size: 14px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>üéµ JamRoom PDF Generator Test</h1>
            <p>Test client-side PDF generation with database-accurate mock data</p>
        </div>
        
        <div class="test-section">
            <h3>üìÑ PDF Generation Test</h3>
            <p><strong>Generate PDF with mock data that matches your database schema exactly:</strong></p>
            
            <button class="test-button" onclick="generatePDF()">
                üéµ Generate PDF with Mock Data
            </button>
            
            <button class="test-button" onclick="togglePreview()">
                üëÄ Preview Mock Data Structure
            </button>
            
            <div class="highlight-box">
                <p>
                    ‚ú® <strong>This test uses mock data that matches your actual database schema.</strong><br>
                    üìä Features: rentals array, proper pricing, 24‚Üí12 hour time conversion, all required fields.
                </p>
            </div>
            
            <div class="loading" id="loading">
                <p>‚è≥ Generating PDF... This may take a few seconds.</p>
            </div>
            
            <div id="status"></div>
            
            <div class="data-preview" id="dataPreview"></div>
        </div>
        
        <div class="test-section">
            <h3>üíª Server Testing (Optional)</h3>
            <p>To test with real database data, start the Node.js server:</p>
            
            <div class="code-block">
                <div>cd JamRoom</div>
                <div>node server.js</div>
                <div style="color: #38a169; margin-top: 8px;"># Then visit: http://localhost:5000/test-client-pdf.html</div>
            </div>
            
            <button class="test-button" onclick="checkServer()">
                üîç Check Node.js Server Status
            </button>
        </div>
        
        <div class="test-section">
            <h3>‚ÑπÔ∏è Test Information</h3>
            <ul style="color: #4a5568; line-height: 1.8;">
                <li><strong>Purpose:</strong> Test client-side PDF generation with schema-accurate mock data</li>
                <li><strong>Mock Data:</strong> Matches actual Booking + AdminSettings models exactly</li>
                <li><strong>Libraries:</strong> html2pdf.js (loaded dynamically from CDN)</li>
                <li><strong>Features:</strong> 12-hour time format, proper rentals array, all required fields</li>
                <li><strong>Output:</strong> Professional invoice PDF with clean styling (no gradient issues)</li>
            </ul>
        </div>
    </div>

    <!-- Include the client PDF generator -->
    <script src="js/client-pdf-generator.js"></script>
    
    <script>
        // Mock data matching exact database schema
        const mockBooking = {
            _id: "507f1f77bcf86cd799439011",
            userId: "507f1f77bcf86cd799439012", // User ObjectId reference
            user: {
                name: "John Doe",
                email: "john.doe@example.com",
                phone: "+91 9876543210"
            },
            date: "2026-01-25",
            startTime: "14:30", // 24-hour format - will convert to 2:30 PM
            endTime: "16:30",   // 24-hour format - will convert to 4:30 PM
            duration: 2,
            rentalType: "Multiple Items", // Legacy field for backward compatibility
            rentals: [ // New rentals array structure as per schema
                {
                    name: "Studio Recording Session",
                    description: "2-hour professional recording session with equipment",
                    price: 2000,
                    quantity: 1
                }
            ],
            price: 2360, // Total including tax
            subtotal: 2000, // Required field - subtotal before tax
            taxAmount: 360, // Required field - 18% GST = 2000 * 0.18
            paymentStatus: "PAID", // Enum: PENDING, PAID, REFUNDED
            bookingStatus: "CONFIRMED", // Enum: PENDING, CONFIRMED, REJECTED, CANCELLED
            paymentReference: "PAY_123456789",
            userName: "John Doe", // Required field - user's name
            userEmail: "john.doe@example.com", // Required field - user's email
            bandName: "The Rock Stars", // Optional field
            notes: "Please ensure all equipment is ready by 2:00 PM",
            createdAt: new Date().toISOString()
        };
        
        const mockSettings = {
            studioName: "Swar JamRoom Studio",
            studioAddress: "123 Music Street\\nBangalore, Karnataka 560001\\nIndia",
            studioPhone: "+91 9876543210",
            adminEmails: ["admin@swarjamroom.com", "swarjrs@gmail.com"],
            taxRate: 0.18, // 18% GST
            upiId: "swarjamroom@paytm",
            companyRegistration: "CIN: U74999KA2023PTC123456",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        // Helper functions
        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showLoading(show = true) {
            const loading = document.getElementById('loading');
            loading.classList.toggle('show', show);
        }
        
        // Main PDF generation function
        async function generatePDF() {
            const button = event.target;
            
            try {
                showLoading(true);
                button.disabled = true;
                showStatus('info', 'üîÑ Loading PDF libraries and generating mock PDF...');
                
                // Generate PDF using the client-side generator with mock data
                await generatePDFClient(mockBooking, mockSettings);
                
                showLoading(false);
                showStatus('success', '‚úÖ PDF generated successfully! Check your downloads folder. Time format: 14:30 ‚Üí 2:30 PM');
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                showLoading(false);
                showStatus('error', `‚ùå PDF generation failed: ${error.message}`);
            } finally {
                button.disabled = false;
            }
        }
        
        // Preview mock data
        function togglePreview() {
            const preview = document.getElementById('dataPreview');
            const dataToShow = {
                booking: mockBooking,
                settings: mockSettings,
                note: 'This data structure matches your actual MongoDB schema exactly'
            };
            
            if (preview.style.display === 'none' || !preview.style.display) {
                preview.textContent = JSON.stringify(dataToShow, null, 2);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Check server status
        async function checkServer() {
            try {
                showStatus('info', 'üîÑ Checking Node.js server connection...');
                
                const response = await fetch('http://localhost:5000/api/booking/settings', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000) // 3 second timeout
                });
                
                if (response.ok || response.status === 401 || response.status === 404) {
                    showStatus('success', '‚úÖ Node.js server is running! Visit: http://localhost:5000/test-pdf-working.html');
                } else {
                    showStatus('error', `‚ö†Ô∏è Server responded with status ${response.status}. Check server logs.`);
                }
            } catch (error) {
                showStatus('error', '‚ùå Node.js server not running. Start with: node server.js');
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéµ JamRoom PDF Test Page Loaded');
            console.log('Mock booking data (matches schema):', mockBooking);
            console.log('Mock settings:', mockSettings);
            
            showStatus('info', '‚ÑπÔ∏è Ready to test! Click "Generate PDF with Mock Data" to start.');
        });
    </script>
</body>
</html>