<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - JamRoom</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }
        .topbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topbar h1 { font-size: 1.8em; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 0 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        
        .dashboard {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .stat-card .number { font-size: 2.5em; color: #667eea; font-weight: bold; }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .section h2 { margin-bottom: 20px; color: #333; }
        
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e1e8ed;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -2px;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-cancelled { background: #e2e3e5; color: #383d41; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .time-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 300px;
            max-width: 500px;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            font-weight: 500;
        }
        
        .alert.show { display: block; }
        .alert-success { 
            background: #d4edda; 
            color: #155724; 
            border: 2px solid #c3e6cb; 
        }
        .alert-error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 2px solid #f5c6cb; 
        }
        .alert-info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 2px solid #bee5eb; 
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        /* Backdrop for centered alerts */
        .alert-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }
        
        .alert-backdrop.show {
            display: block;
        }
        
        .loading { text-align: center; padding: 20px; color: #666; }
        
        /* Enhanced Loading Indicators */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .loading-content .loader {
            width: 40px;
            height: 40px;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal.show { display: flex; align-items: center; justify-content: center; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        /* Calendar Styles */
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-controls select {
            width: auto;
            min-width: 120px;
        }
        
        #calendar {
            background: white;
        }
        
        .fc-event {
            cursor: pointer;
        }
        
        .fc-event:hover {
            opacity: 0.8;
        }
        
        .close:hover { color: #333; }
        
        .blocked-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <h1>üéõÔ∏è Admin Panel</h1>
        <div>
            <span id="adminName"></span>
            <a href="/index.html" class="btn btn-secondary">Home</a>
            <a href="/booking.html" class="btn btn-primary">Booking Page</a>
            <button onclick="logout()" class="btn btn-danger">Logout</button>
        </div>
    </div>

    <div class="dashboard">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Bookings</h3>
                <div class="number" id="totalBookings">0</div>
            </div>
            <div class="stat-card">
                <h3>Pending Approval</h3>
                <div class="number" id="pendingBookings">0</div>
            </div>
            <div class="stat-card">
                <h3>Confirmed</h3>
                <div class="number" id="confirmedBookings">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="number" id="totalRevenue">‚Çπ0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bookings')">üìã Bookings</button>
                <button class="tab" onclick="switchTab('calendar')">üìÖ Calendar</button>
                <button class="tab" onclick="switchTab('revenue')">üí∞ Revenue</button>
                <button class="tab" onclick="switchTab('blocked')">üö´ Blocked Times</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
                <button class="tab" onclick="switchTab('users')">üë• Users</button>
            </div>

            <!-- Bookings Tab -->
            <div id="bookingsTab" class="tab-content active">
                <h2>Manage Bookings</h2>
                <div id="bookingAlert" class="alert"></div>
                <div id="bookingsLoading" class="loading">Loading bookings...</div>
                <div id="bookingsTable"></div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendarTab" class="tab-content">
                <h2>Booking Calendar</h2>
                <div id="calendarAlert" class="alert"></div>
                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <select id="calendarMonth">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select id="calendarYear"></select>
                    <button class="btn btn-primary" onclick="loadCalendar()">Load Calendar</button>
                </div>
                <div id="calendarLoading" class="loading" style="display: none;">Loading calendar...</div>
                <div id="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="revenueTab" class="tab-content">
                <h2>Revenue Analytics</h2>
                <div id="revenueAlert" class="alert"></div>
                
                <!-- Revenue Filters -->
                <div class="revenue-filters" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>Filter Revenue Data</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label>Quick Filter</label>
                            <select id="revenueFilter" onchange="loadRevenue()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="year">This Year</option>
                                <option value="range">Custom Range</option>
                            </select>
                        </div>
                        
                        <div id="customRangeInputs" style="display: none; grid-column: span 2;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>Start Date</label>
                                    <input type="date" id="revenueStartDate">
                                </div>
                                <div class="form-group">
                                    <label>End Date</label>
                                    <input type="date" id="revenueEndDate">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadRevenue()" style="margin-top: 10px;">Apply Filter</button>
                        </div>
                    </div>
                </div>

                <!-- Revenue Summary Cards -->
                <div class="revenue-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="number" id="revenueTotal">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bookings</h3>
                        <div class="number" id="revenueBookings">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Booking Value</h3>
                        <div class="number" id="revenueAvg">‚Çπ0</div>
                    </div>
                </div>

                <!-- Revenue by Type -->
                <div class="revenue-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div class="section">
                        <h3>Revenue by Rental Type</h3>
                        <div id="revenueByType"></div>
                    </div>
                    <div class="section">
                        <h3>Bookings by Rental Type</h3>
                        <div id="bookingsByType"></div>
                    </div>
                </div>

                <!-- Revenue Table -->
                <div id="revenueLoading" class="loading" style="display: none;">Loading revenue data...</div>
                <div id="revenueTable"></div>
            </div>

            <!-- Blocked Times Tab -->
            <div id="blockedTab" class="tab-content">
                <h2>Blocked Time Slots</h2>
                <button class="btn btn-primary" onclick="showBlockTimeModal()">+ Block New Time</button>
                <div id="blockedAlert" class="alert"></div>
                <div id="blockedLoading" class="loading">Loading blocked times...</div>
                <div id="blockedList"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h2>Admin Settings</h2>
                <div id="settingsAlert" class="alert"></div>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>Studio Name*</label>
                        <input type="text" id="studioName" required placeholder="Swar JamRoom & Music Studio (SwarJRS)">
                    </div>
                    <div class="form-group">
                        <label>Studio Address*</label>
                        <textarea id="studioAddress" rows="3" placeholder="Swar Jam Room and Music Studio - SwarJRS, Zen Business Center - 202, Bhumkar Chowk Rd, above Cafe Coffee Day, Shankar Kalat Nagar, Wakad, Pune, Pimpri-Chinchwad, Maharashtra 411057"></textarea>
                    </div>
                    <div class="form-group">
                        <label>UPI ID*</label>
                        <input type="text" id="upiId" required>
                    </div>
                    <div class="form-group">
                        <label>UPI Name*</label>
                        <input type="text" id="upiName" required>
                    </div>
                    <div class="form-group">
                        <label>Admin Emails (comma-separated)*</label>
                        <textarea id="adminEmails" rows="3" placeholder="admin1@example.com, admin2@example.com"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Save Settings</button>
                </form>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2>Grant Admin Access</h2>
                <div id="userAlert" class="alert"></div>
                <form id="makeAdminForm">
                    <div class="form-group">
                        <label>User Email*</label>
                        <input type="email" id="userEmail" required placeholder="user@example.com">
                    </div>
                    <button type="submit" class="btn btn-warning">Grant Admin Access</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Approve/Reject Booking Modal -->
    <div id="bookingActionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Booking Action</h2>
                <span class="close" onclick="closeModal('bookingActionModal')">&times;</span>
            </div>
            <div id="modalBookingDetails"></div>
            <div class="form-group" id="rejectReasonGroup" style="display:none;">
                <label>Rejection Reason</label>
                <textarea id="rejectReason" rows="3" placeholder="Optional reason for rejection..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="confirmActionBtn" class="btn btn-success" style="flex: 1;">Confirm</button>
                <button onclick="closeModal('bookingActionModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Block Time Modal -->
    <div id="blockTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Block Time Slot</h2>
                <span class="close" onclick="closeModal('blockTimeModal')">&times;</span>
            </div>
            <form id="blockTimeForm">
                <div class="form-group">
                    <label>Date*</label>
                    <input type="date" id="blockDate" required>
                </div>
                <div class="time-container">
                    <div class="form-group">
                        <label>Start Time*</label>
                        <input type="time" id="blockStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>End Time*</label>
                        <input type="time" id="blockEndTime" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Reason (Optional)</label>
                    <input type="text" id="blockReason" placeholder="e.g., Maintenance, Private event">
                </div>
                <button type="submit" class="btn btn-danger" style="width: 100%;">Block Time</button>
            </form>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loader"></div>
            <div id="loadingMessage">Processing...</div>
        </div>
    </div>

    <!-- Alert Backdrop -->
    <div id="alertBackdrop" class="alert-backdrop"></div>
    
    <!-- Centered Alert -->
    <div id="centeredAlert" class="alert">
        <div id="centeredAlertMessage"></div>
    </div>

    <!-- Confirmation Modals -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmationTitle">Confirm Action</h2>
                <span class="close" onclick="closeModal('confirmationModal')">&times;</span>
            </div>
            <div id="confirmationMessage">Are you sure?</div>
            <div class="form-group" id="reasonGroup" style="display: none; margin-top: 15px;">
                <label for="rejectionReason">Rejection Reason (Optional):</label>
                <textarea id="rejectionReason" placeholder="Enter reason for rejection..." rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="confirmButton" class="btn btn-primary" style="flex: 1;">Confirm</button>
                <button onclick="closeModal('confirmationModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Booking Modal -->
    <div id="editBookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Booking</h2>
                <span class="close" onclick="closeModal('editBookingModal')">&times;</span>
            </div>
            <form id="editBookingForm">
                <div class="form-group">
                    <label for="editDate">Date*</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editStartTime">Start Time*</label>
                        <select id="editStartTime" required>
                            <option value="">Select time</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                            <option value="22:00">10:00 PM</option>
                            <option value="23:00">11:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDuration">Duration (hours)*</label>
                        <select id="editDuration" required>
                            <option value="">Select</option>
                            <option value="1">1 hour</option>
                            <option value="2">2 hours</option>
                            <option value="3">3 hours</option>
                            <option value="4">4 hours</option>
                            <option value="5">5 hours</option>
                            <option value="6">6 hours</option>
                            <option value="7">7 hours</option>
                            <option value="8">8 hours</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editRentalType">Rental Type*</label>
                    <input type="text" id="editRentalType" required>
                </div>
                <div class="form-group">
                    <label for="editPrice">Price (‚Çπ)*</label>
                    <input type="number" id="editPrice" required min="0">
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Update Booking</button>
                    <button type="button" onclick="closeModal('editBookingModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUser = null;

        // Utility functions
        const showAlert = (elementId, message, type = 'info') => {
            // Use centered alert system for better UX
            const backdrop = document.getElementById('alertBackdrop');
            const alert = document.getElementById('centeredAlert');
            const messageEl = document.getElementById('centeredAlertMessage');
            
            messageEl.textContent = message;
            alert.className = `alert alert-${type} show`;
            backdrop.classList.add('show');
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                alert.classList.remove('show');
                backdrop.classList.remove('show');
            }, 4000);
            
            // Also allow clicking backdrop to close
            backdrop.onclick = () => {
                alert.classList.remove('show');
                backdrop.classList.remove('show');
            };
        };

        // Loading utility functions
        const showLoading = (message = 'Loading...') => {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = message;
            overlay.classList.add('show');
        };

        const hideLoading = () => {
            document.getElementById('loadingOverlay').classList.remove('show');
        };

        const showButtonLoading = (buttonId, originalText) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('loading');
                button.textContent = '';
                button.setAttribute('data-original-text', originalText);
            }
        };

        const hideButtonLoading = (buttonId) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.remove('loading');
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.textContent = originalText;
                    button.removeAttribute('data-original-text');
                }
            }
        };

        const showSectionLoading = (containerId, message = 'Loading...') => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loader"></div>
                        ${message}
                    </div>
                `;
            }
        };

        // Confirmation modal functions
        const showConfirmationModal = (title, message, confirmText, onConfirm, showReason = false) => {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmButton').textContent = confirmText;
            
            const reasonGroup = document.getElementById('reasonGroup');
            const rejectionReason = document.getElementById('rejectionReason');
            
            if (showReason) {
                reasonGroup.style.display = 'block';
                rejectionReason.value = '';
            } else {
                reasonGroup.style.display = 'none';
            }
            
            document.getElementById('confirmationModal').classList.add('show');
            
            // Remove any existing listeners and add new one
            const confirmButton = document.getElementById('confirmButton');
            const newButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newButton, confirmButton);
            
            newButton.onclick = () => {
                closeModal('confirmationModal');
                onConfirm();
            };
        };

        const formatDate = (dateStr) => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        };

        const formatTime = (time) => {
            if (!time) return 'N/A';
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('show');
        };

        const showBlockTimeModal = () => {
            document.getElementById('blockTimeForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('blockDate').setAttribute('min', today);
            document.getElementById('blockTimeModal').classList.add('show');
        };

        // Authentication
        const checkAuth = async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Not authenticated');

                const data = await res.json();
                currentUser = data.user;
                
                if (currentUser.role !== 'admin') {
                    alert('Admin access required');
                    window.location.href = '/index.html';
                    return;
                }

                document.getElementById('adminName').textContent = `Admin: ${currentUser.name}`;
                await loadStats();
                await loadBookings();
            } catch (error) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        };

        const logout = () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        };

        // Tab switching
        const switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'bookings') loadBookings();
            if (tab === 'calendar') initCalendar();
            if (tab === 'revenue') loadRevenue();
            if (tab === 'blocked') loadBlockedTimes();
            if (tab === 'settings') loadSettings();
        };

        // Load statistics
        const loadStats = async () => {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load stats');

                const data = await res.json();
                document.getElementById('totalBookings').textContent = data.stats.totalBookings;
                document.getElementById('pendingBookings').textContent = data.stats.pendingBookings;
                document.getElementById('confirmedBookings').textContent = data.stats.confirmedBookings;
                document.getElementById('totalRevenue').textContent = `‚Çπ${data.stats.totalRevenue}`;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        };

        // Calendar functionality
        let calendar = null;

        const initCalendar = () => {
            if (calendar) {
                calendar.destroy();
            }

            // Initialize month/year selectors
            const now = new Date();
            const monthSelect = document.getElementById('calendarMonth');
            const yearSelect = document.getElementById('calendarYear');
            
            // Set current month
            monthSelect.value = now.getMonth();
            
            // Populate year options
            yearSelect.innerHTML = '';
            for (let year = now.getFullYear() - 1; year <= now.getFullYear() + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === now.getFullYear()) option.selected = true;
                yearSelect.appendChild(option);
            }

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                eventClick: function(info) {
                    const booking = info.event.extendedProps;
                    alert(`Booking Details:
Name: ${booking.userName}
Email: ${booking.userEmail}
Band: ${booking.bandName || 'N/A'}
Type: ${booking.rentalType}
Price: ‚Çπ${booking.price}
Status: ${booking.status}
Payment: ${booking.paymentStatus}
Notes: ${booking.notes || 'N/A'}`);
                },
                eventDidMount: function(info) {
                    const booking = info.event.extendedProps;
                    info.el.setAttribute('title', `${booking.userName} - ${booking.rentalType} (${booking.status})`);
                }
            });

            calendar.render();
            loadCalendar();
        };

        const loadCalendar = async () => {
            try {
                const month = document.getElementById('calendarMonth').value;
                const year = document.getElementById('calendarYear').value;
                
                showSectionLoading('calendar', 'Loading calendar events...');
                
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/bookings/calendar?month=${month}&year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load calendar data');

                const data = await res.json();
                
                // Clear existing events
                calendar.removeAllEvents();
                
                // Add new events
                calendar.addEventSource(data.events);
                
                // Navigate calendar to selected month
                calendar.gotoDate(new Date(parseInt(year), parseInt(month), 1));
                
            } catch (error) {
                console.error('Failed to load calendar:', error);
                showAlert('calendarAlert', 'Failed to load calendar data', 'error');
            }
        };

        // Revenue functionality
        const loadRevenue = async () => {
            try {
                showSectionLoading('revenueTable', 'Loading revenue data...');
                
                const filter = document.getElementById('revenueFilter').value;
                let url = `${API_URL}/api/admin/revenue?filter=${filter}`;
                
                // Handle custom range
                if (filter === 'range') {
                    const startDate = document.getElementById('revenueStartDate').value;
                    const endDate = document.getElementById('revenueEndDate').value;
                    
                    if (!startDate || !endDate) {
                        showAlert('revenueAlert', 'Please select both start and end dates for custom range', 'error');
                        return;
                    }
                    
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                }

                const token = localStorage.getItem('token');
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load revenue data');

                const data = await res.json();
                
                // Update summary cards
                document.getElementById('revenueTotal').textContent = `‚Çπ${data.revenue.totalRevenue}`;
                document.getElementById('revenueBookings').textContent = data.revenue.totalBookings;
                document.getElementById('revenueAvg').textContent = `‚Çπ${data.revenue.avgBookingValue}`;
                
                // Update revenue by type
                updateRevenueCharts(data.revenue);
                
                // Update revenue table
                updateRevenueTable(data.bookings);
                
            } catch (error) {
                console.error('Failed to load revenue:', error);
                showAlert('revenueAlert', 'Failed to load revenue data', 'error');
            }
        };

        const updateRevenueCharts = (revenue) => {
            // Revenue by type
            const revenueByTypeHtml = Object.entries(revenue.revenueByType)
                .sort(([,a], [,b]) => b - a)
                .map(([type, amount]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${type}</span>
                        <strong>‚Çπ${amount}</strong>
                    </div>
                `).join('') || '<p style="text-align: center; color: #666;">No data available</p>';
            
            document.getElementById('revenueByType').innerHTML = revenueByTypeHtml;
            
            // Bookings by type
            const bookingsByTypeHtml = Object.entries(revenue.bookingsByType)
                .sort(([,a], [,b]) => b - a)
                .map(([type, count]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${type}</span>
                        <strong>${count} booking${count !== 1 ? 's' : ''}</strong>
                    </div>
                `).join('') || '<p style="text-align: center; color: #666;">No data available</p>';
                
            document.getElementById('bookingsByType').innerHTML = bookingsByTypeHtml;
        };

        const updateRevenueTable = (bookings) => {
            if (bookings.length === 0) {
                document.getElementById('revenueTable').innerHTML = '<p style="text-align: center; color: #666;">No bookings found for the selected period</p>';
                return;
            }

            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Type</th>
                            <th>Band</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(booking => `
                            <tr>
                                <td>${formatDate(booking.date)}</td>
                                <td>${booking.userName}<br><small>${booking.userEmail}</small></td>
                                <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                                <td>${booking.duration}h</td>
                                <td>${booking.rentalType}</td>
                                <td>${booking.bandName || 'N/A'}</td>
                                <td><strong>‚Çπ${booking.price}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('revenueTable').innerHTML = tableHtml;
        };

        // Show/hide custom range inputs
        document.addEventListener('DOMContentLoaded', () => {
            const revenueFilter = document.getElementById('revenueFilter');
            if (revenueFilter) {
                revenueFilter.addEventListener('change', (e) => {
                    const customRangeInputs = document.getElementById('customRangeInputs');
                    if (e.target.value === 'range') {
                        customRangeInputs.style.display = 'block';
                    } else {
                        customRangeInputs.style.display = 'none';
                        if (e.target.value !== 'range') {
                            loadRevenue();
                        }
                    }
                });
            }
        });

        // Load bookings
        const loadBookings = async () => {
            try {
                showSectionLoading('bookingsTable', 'Loading bookings...');
                
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/bookings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load bookings');

                const data = await res.json();
                
                document.getElementById('bookingsLoading').style.display = 'none';
                
                if (data.bookings.length === 0) {
                    document.getElementById('bookingsTable').innerHTML = 
                        '<p style="text-align:center; padding: 20px; color:#666;">No bookings found</p>';
                    return;
                }

                let html = '<table><thead><tr><th>User</th><th>Date</th><th>Time</th><th>Duration</th><th>Type</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                data.bookings.forEach(booking => {
                    // Skip old bookings that don't have the new schema
                    if (!booking.startTime || !booking.endTime || !booking.duration) {
                        console.log('Skipping old booking:', booking._id);
                        return;
                    }
                    
                    const statusClass = booking.bookingStatus.toLowerCase();
                    const userName = booking.userId?.name || booking.userName || 'N/A';
                    const userEmail = booking.userId?.email || booking.userEmail || 'N/A';
                    
                    html += `
                        <tr>
                            <td>${userName}<br><small>${userEmail}</small></td>
                            <td>${formatDate(booking.date)}</td>
                            <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                            <td>${booking.duration} hour(s)</td>
                            <td>${booking.rentalType}</td>
                            <td>‚Çπ${booking.price}</td>
                            <td><span class="status-badge status-${statusClass}">${booking.bookingStatus}</span></td>
                            <td>
                                ${booking.bookingStatus === 'PENDING' ? `
                                    <button onclick="approveBooking('${booking._id}')" class="btn btn-success btn-sm">Approve</button>
                                    <button onclick="rejectBooking('${booking._id}')" class="btn btn-danger btn-sm">Reject</button>
                                ` : ''}
                                <button onclick="editBooking('${booking._id}', ${JSON.stringify(booking).replace(/"/g, '&quot;')})" class="btn btn-warning btn-sm">Edit</button>
                                <button onclick="deleteBooking('${booking._id}')" class="btn btn-danger btn-sm">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('bookingsTable').innerHTML = html;
            } catch (error) {
                console.error('Load bookings error:', error);
                document.getElementById('bookingsTable').innerHTML = 
                    '<p style="color: #dc3545;">Failed to load bookings: ' + error.message + '</p>';
            }
        };

        // Approve booking
        const approveBooking = async (bookingId) => {
            showConfirmationModal(
                'Approve Booking',
                'Are you sure you want to approve this booking? This will confirm the reservation and send a notification to the customer.',
                'Approve',
                async () => {
                    try {
                        showLoading('Approving booking...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}/approve`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!res.ok) throw new Error('Failed to approve booking');

                        showAlert('bookingAlert', 'Booking approved successfully!', 'success');
                        await loadStats();
                        await loadBookings();
                    } catch (error) {
                        showAlert('bookingAlert', error.message, 'error');
                    } finally {
                        hideLoading();
                    }
                }
            );
        };

        // Reject booking
        const rejectBooking = async (bookingId) => {
            showConfirmationModal(
                'Reject Booking',
                'Are you sure you want to reject this booking? This will notify the customer that their booking has been declined.',
                'Reject',
                async () => {
                    const reason = document.getElementById('rejectionReason').value.trim();
                    
                    try {
                        showLoading('Rejecting booking...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}/reject`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ reason: reason || undefined })
                        });

                        if (!res.ok) throw new Error('Failed to reject booking');

                        showAlert('bookingAlert', 'Booking rejected', 'info');
                        await loadStats();
                        await loadBookings();
                    } catch (error) {
                        showAlert('bookingAlert', error.message, 'error');
                    } finally {
                        hideLoading();
                    }
                },
                true // Show reason input
            );
        };

        // Edit booking
        let currentEditingBookingId = null;
        
        const editBooking = (bookingId, bookingData) => {
            try {
                currentEditingBookingId = bookingId;
                
                // Parse booking data if it's a string
                const booking = typeof bookingData === 'string' ? JSON.parse(bookingData.replace(/&quot;/g, '"')) : bookingData;
                
                // Format date for input (YYYY-MM-DD)
                const bookingDate = new Date(booking.date);
                const formattedDate = bookingDate.toISOString().split('T')[0];
                
                // Calculate end time from start time and duration
                const calculateEndTime = (startTime, duration) => {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + (duration * 60);
                    const endHours = Math.floor(totalMinutes / 60) % 24;
                    const endMins = totalMinutes % 60;
                    return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                };
                
                // Populate form fields
                document.getElementById('editDate').value = formattedDate;
                document.getElementById('editStartTime').value = booking.startTime;
                document.getElementById('editDuration').value = booking.duration;
                document.getElementById('editRentalType').value = booking.rentalType;
                document.getElementById('editPrice').value = booking.price;
                document.getElementById('editNotes').value = booking.notes || '';
                
                // Show modal
                document.getElementById('editBookingModal').style.display = 'block';
            } catch (error) {
                console.error('Error opening edit modal:', error);
                showAlert('bookingAlert', 'Error opening edit form', 'error');
            }
        };

        // Delete booking
        const deleteBooking = (bookingId) => {
            showConfirmationModal(
                'Delete Booking',
                'Are you sure you want to delete this booking? This action cannot be undone and will notify the customer.',
                'Delete',
                async () => {
                    try {
                        showLoading('Deleting booking...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!res.ok) throw new Error('Failed to delete booking');

                        showAlert('bookingAlert', 'Booking deleted successfully', 'success');
                        await loadStats();
                        await loadBookings();
                    } catch (error) {
                        showAlert('bookingAlert', error.message, 'error');
                    } finally {
                        hideLoading();
                    }
                }
            );
        };

        // Load blocked times
        const loadBlockedTimes = async () => {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/blocked-times`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load blocked times');

                const data = await res.json();
                
                document.getElementById('blockedLoading').style.display = 'none';
                
                if (data.blockedTimes.length === 0) {
                    document.getElementById('blockedList').innerHTML = 
                        '<p style="text-align:center; padding: 20px; color:#666;">No blocked times</p>';
                    return;
                }

                let html = '';
                data.blockedTimes.forEach(blocked => {
                    html += `
                        <div class="blocked-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>${formatDate(blocked.date)}</h4>
                                    <p><strong>Time:</strong> ${formatTime(blocked.startTime)} - ${formatTime(blocked.endTime)}</p>
                                    <p><strong>Reason:</strong> ${blocked.reason}</p>
                                    <small>Blocked by: ${blocked.blockedBy.name}</small>
                                </div>
                                <button onclick="unblockTime('${blocked._id}')" class="btn btn-danger btn-sm">Unblock</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('blockedList').innerHTML = html;
            } catch (error) {
                document.getElementById('blockedList').innerHTML = 
                    '<p style="color: #dc3545;">Failed to load blocked times</p>';
            }
        };

        // Edit booking form handler
        document.getElementById('editBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditingBookingId) {
                showAlert('bookingAlert', 'No booking selected for editing', 'error');
                return;
            }

            try {
                showLoading('Updating booking...');

                const formData = {
                    date: document.getElementById('editDate').value,
                    startTime: document.getElementById('editStartTime').value,
                    duration: parseInt(document.getElementById('editDuration').value),
                    rentalType: document.getElementById('editRentalType').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    notes: document.getElementById('editNotes').value
                };

                // Calculate end time
                const calculateEndTime = (startTime, duration) => {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + (duration * 60);
                    const endHours = Math.floor(totalMinutes / 60) % 24;
                    const endMins = totalMinutes % 60;
                    return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                };

                formData.endTime = calculateEndTime(formData.startTime, formData.duration);

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/bookings/${currentEditingBookingId}/edit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Failed to update booking');
                }

                closeModal('editBookingModal');
                showAlert('bookingAlert', 'Booking updated successfully!', 'success');
                await loadStats();
                await loadBookings();
                currentEditingBookingId = null;

            } catch (error) {
                showAlert('bookingAlert', error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Block time
        document.getElementById('blockTimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                date: document.getElementById('blockDate').value,
                startTime: document.getElementById('blockStartTime').value,
                endTime: document.getElementById('blockEndTime').value,
                reason: document.getElementById('blockReason').value
            };

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/block-time`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Failed to block time');
                }

                showAlert('blockedAlert', 'Time blocked successfully!', 'success');
                closeModal('blockTimeModal');
                await loadBlockedTimes();
            } catch (error) {
                showAlert('blockedAlert', error.message, 'error');
            }
        });

        // Unblock time
        const unblockTime = async (blockedId) => {
            if (!confirm('Remove this blocked time?')) return;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/blocked-times/${blockedId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to unblock time');

                showAlert('blockedAlert', 'Time unblocked successfully!', 'success');
                await loadBlockedTimes();
            } catch (error) {
                showAlert('blockedAlert', error.message, 'error');
            }
        };

        // Load settings
        const loadSettings = async () => {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load settings');

                const data = await res.json();
                const settings = data.settings;

                document.getElementById('studioName').value = settings.studioName || 'JamRoom Studio';
                document.getElementById('studioAddress').value = settings.studioAddress || '';
                document.getElementById('upiId').value = settings.upiId;
                document.getElementById('upiName').value = settings.upiName;
                document.getElementById('adminEmails').value = settings.adminEmails.join(', ');
            } catch (error) {
                showAlert('settingsAlert', 'Failed to load settings', 'error');
            }
        };

        // Save settings
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                studioName: document.getElementById('studioName').value,
                studioAddress: document.getElementById('studioAddress').value,
                upiId: document.getElementById('upiId').value,
                upiName: document.getElementById('upiName').value,
                adminEmails: document.getElementById('adminEmails').value.split(',').map(e => e.trim()).filter(e => e)
            };

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!res.ok) throw new Error('Failed to save settings');

                showAlert('settingsAlert', 'Settings saved successfully!', 'success');
            } catch (error) {
                showAlert('settingsAlert', error.message, 'error');
            }
        });

        // Make admin
        document.getElementById('makeAdminForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('userEmail').value;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/make-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Failed to grant admin access');
                }

                showAlert('userAlert', `Admin access granted to ${email}`, 'success');
                document.getElementById('makeAdminForm').reset();
            } catch (error) {
                showAlert('userAlert', error.message, 'error');
            }
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>
