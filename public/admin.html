<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - JamRoom</title>
    <!-- Client-side PDF Generation -->
    <script src="/js/client-pdf-generator.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            letter-spacing: -0.01em;
        }
        .topbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .topbar h1 { 
            font-size: 1.9em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 5px;
            text-decoration: none;
            display: inline-block;
            letter-spacing: 0.01em;
        }
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-2px);
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-success { 
            background: #28a745; 
            color: white;
            box-shadow: 0 3px 12px rgba(40, 167, 69, 0.3);
        }
        .btn-danger { 
            background: #dc3545; 
            color: white;
            box-shadow: 0 3px 12px rgba(220, 53, 69, 0.3);
        }
        .btn-warning { 
            background: #ffc107; 
            color: #000;
            box-shadow: 0 3px 12px rgba(255, 193, 7, 0.3);
        }
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        .btn-sm { 
            padding: 8px 14px; 
            font-size: 0.9em;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .topbar {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .topbar h1 {
                font-size: 1.4em;
            }
            
            .dashboard {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2em;
            }
            
            .section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .section h2 {
                font-size: 1.3em;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85em;
                margin: 2px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 0.75em;
            }
            
            /* Make tables responsive */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border: 1px solid #e1e8ed;
                border-radius: 8px;
                margin: 20px 0;
                width: 100%;
            }
            
            .table-container table {
                min-width: 800px;
                margin: 0;
            }
            
            /* Calendar responsive adjustments */
            .fc-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .fc-button-group {
                flex-wrap: wrap;
            }
            
            .fc-daygrid-day-number {
                font-size: 0.8em;
            }
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 { 
            color: #6c757d; 
            font-size: 0.9em; 
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .stat-card .number { 
            font-size: 2.75em; 
            color: #667eea; 
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .section h2 { margin-bottom: 20px; color: #333; }
        
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e1e8ed;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -2px;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 1em;
        }
        
        @media (max-width: 768px) {
            table {
                font-size: 0.9em;
            }
            
            table th, table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            /* Only hide Type column on medium screens, keep all other columns */
            table th:nth-child(5), 
            table td:nth-child(5) {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            table {
                font-size: 0.85em;
            }
            
            table th, table td {
                padding: 6px 4px;
            }
            
            /* Hide Type and Price columns on very small screens, but keep Actions */
            table th:nth-child(5), 
            table td:nth-child(5),
            table th:nth-child(6), 
            table td:nth-child(6) {
                display: none;
            }
            
            .btn-sm {
                padding: 4px 6px;
                font-size: 0.75em;
            }
        }
        
        table th, table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
            font-size: 0.98em;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }
        
        table td small {
            font-size: 0.85em;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-cancelled { background: #e2e3e5; color: #383d41; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .time-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .time-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 300px;
            max-width: 500px;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            font-weight: 500;
        }
        
        @media (max-width: 480px) {
            .alert {
                min-width: 280px;
                max-width: 90vw;
                padding: 12px;
                font-size: 0.9em;
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
        }
        
        .alert.show { display: block; }
        .alert-success { 
            background: #d4edda; 
            color: #155724; 
            border: 2px solid #c3e6cb; 
        }
        .alert-error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 2px solid #f5c6cb; 
        }
        .alert-info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 2px solid #bee5eb; 
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        /* Backdrop for centered alerts */
        .alert-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }
        
        .alert-backdrop.show {
            display: block;
        }
        
        .loading { text-align: center; padding: 20px; color: #666; }
        
        /* Enhanced Loading Indicators */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .loading-content .loader {
            width: 40px;
            height: 40px;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal.show { display: flex; align-items: center; justify-content: center; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        /* Calendar Styles */
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-controls select {
            width: auto;
            min-width: 120px;
        }
        
        #calendar {
            background: white;
        }
        
        .fc-event {
            cursor: pointer;
        }
        
        .fc-event:hover {
            opacity: 0.8;
        }
        
        .close:hover { color: #333; }
        
        .blocked-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <h1>üéõÔ∏è Admin Panel</h1>
        <div>
            <span id="adminName"></span>
            <a href="/index.html" class="btn btn-secondary">Home</a>
            <a href="/account.html" class="btn btn-secondary">My Account</a>
            <a href="/booking.html" class="btn btn-primary">Booking Page</a>
            <a href="/test.html" class="btn btn-warning">üß™ Full Test Suite</a>
            <a href="/test-rental-system.html" class="btn btn-success">üé∏ Rental System Tests</a>
            <button onclick="logout()" class="btn btn-danger">Logout</button>
        </div>
    </div>

    <div class="dashboard">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Bookings</h3>
                <div class="number" id="totalBookings">0</div>
            </div>
            <div class="stat-card">
                <h3>Pending Approval</h3>
                <div class="number" id="pendingBookings">0</div>
            </div>
            <div class="stat-card">
                <h3>Confirmed</h3>
                <div class="number" id="confirmedBookings">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="number" id="totalRevenue">‚Çπ0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bookings')">üìã Bookings</button>
                <button class="tab" onclick="switchTab('calendar')">üìÖ Calendar</button>
                <button class="tab" onclick="switchTab('revenue')">üí∞ Revenue</button>
                <button class="tab" onclick="switchTab('blocked')">üö´ Blocked Times</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
                <button class="tab" onclick="switchTab('users')">üë• Users</button>
            </div>

            <!-- Bookings Tab -->
            <div id="bookingsTab" class="tab-content active">
                <h2>Manage Bookings</h2>
                <div id="bookingAlert" class="alert"></div>
                <div id="bookingsLoading" class="loading">Loading bookings...</div>
                <div id="bookingsTable"></div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendarTab" class="tab-content">
                <h2>Booking Calendar</h2>
                <div id="calendarAlert" class="alert"></div>
                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <select id="calendarMonth">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select id="calendarYear"></select>
                    <button class="btn btn-primary" onclick="loadCalendar()">Load Calendar</button>
                </div>
                <div id="calendarLoading" class="loading" style="display: none;">Loading calendar...</div>
                <div id="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="revenueTab" class="tab-content">
                <h2>Revenue Analytics</h2>
                <div id="revenueAlert" class="alert"></div>
                
                <!-- Revenue Filters -->
                <div class="revenue-filters" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>Filter Revenue Data</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label>Quick Filter</label>
                            <select id="revenueFilter" onchange="loadRevenue()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="year">This Year</option>
                                <option value="range">Custom Range</option>
                            </select>
                        </div>
                        
                        <div id="customRangeInputs" style="display: none; grid-column: span 2;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>Start Date</label>
                                    <input type="date" id="revenueStartDate">
                                </div>
                                <div class="form-group">
                                    <label>End Date</label>
                                    <input type="date" id="revenueEndDate">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadRevenue()" style="margin-top: 10px;">Apply Filter</button>
                        </div>
                    </div>
                </div>

                <!-- Revenue Summary Cards -->
                <div class="revenue-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="number" id="revenueTotal">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bookings</h3>
                        <div class="number" id="revenueBookings">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Booking Value</h3>
                        <div class="number" id="revenueAvg">‚Çπ0</div>
                    </div>
                </div>

                <!-- Revenue by Type -->
                <div class="revenue-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div class="section">
                        <h3>Revenue by Rental Type</h3>
                        <div id="revenueByType"></div>
                    </div>
                    <div class="section">
                        <h3>Bookings by Rental Type</h3>
                        <div id="bookingsByType"></div>
                    </div>
                </div>

                <!-- Revenue Table -->
                <div id="revenueLoading" class="loading" style="display: none;">Loading revenue data...</div>
                <div id="revenueTable"></div>
            </div>

            <!-- Blocked Times Tab -->
            <div id="blockedTab" class="tab-content">
                <h2>Blocked Time Slots</h2>
                <button class="btn btn-primary" onclick="showBlockTimeModal()">+ Block New Time</button>
                <div id="blockedAlert" class="alert"></div>
                <div id="blockedLoading" class="loading">Loading blocked times...</div>
                <div id="blockedList"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h2>Admin Settings</h2>
                <div id="settingsAlert" class="alert"></div>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>Studio Name*</label>
                        <input type="text" id="studioName" required placeholder="Swar JamRoom & Music Studio (SwarJRS)">
                    </div>
                    <div class="form-group">
                        <label>Studio Address*</label>
                        <textarea id="studioAddress" rows="3" placeholder="Swar Jam Room and Music Studio - SwarJRS, Zen Business Center - 202, Bhumkar Chowk Rd, above Cafe Coffee Day, Shankar Kalat Nagar, Wakad, Pune, Pimpri-Chinchwad, Maharashtra 411057"></textarea>
                    </div>
                    <div class="form-group">
                        <label>UPI ID*</label>
                        <input type="text" id="upiId" required>
                    </div>
                    <div class="form-group">
                        <label>UPI Name*</label>
                        <input type="text" id="upiName" required>
                    </div>
                    <div class="form-group">
                        <label>Admin Emails (comma-separated)*</label>
                        <textarea id="adminEmails" rows="3" placeholder="admin1@example.com, admin2@example.com"></textarea>
                    </div>
                    
                    <!-- GST Configuration Section -->
                    <h3 style="margin: 30px 0 20px 0; color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px;">üßæ GST/Tax Configuration</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="gstEnabled" style="margin-right: 10px; transform: scale(1.2);">
                                <span style="font-weight: 600;">Enable GST/Tax on Bills</span>
                            </label>
                            <small style="color: #6c757d; margin-top: 5px; display: block;">When disabled, all bills will show subtotal only without any tax</small>
                        </div>
                        <div id="gstDetails" style="margin-top: 15px; display: none;">
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>GST Rate (%)</label>
                                    <input type="number" id="gstRate" min="0" max="100" step="0.01" placeholder="18" style="width: 100%;">
                                    <small style="color: #6c757d;">Enter percentage (e.g., 18 for 18%)</small>
                                </div>
                                <div>
                                    <label>Display Name</label>
                                    <input type="text" id="gstDisplayName" placeholder="GST" maxlength="20" style="width: 100%;">
                                    <small style="color: #6c757d;">What to call it on bills (e.g., GST, Tax, VAT)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rental Types and Pricing Section -->
                    <h3 style="margin: 30px 0 20px 0; color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px;">üè∑Ô∏è Rental Types & Pricing</h3>
                    <div id="rentalTypesContainer">
                        <!-- Rental types will be loaded here dynamically -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addRentalType()" style="margin-bottom: 20px;">+ Add Rental Type</button>
                    
                    <button type="submit" class="btn btn-success">Save Settings</button>
                </form>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2>Grant Admin Access</h2>
                <div id="userAlert" class="alert"></div>
                <form id="makeAdminForm">
                    <div class="form-group">
                        <label>User Email*</label>
                        <input type="email" id="userEmail" required placeholder="user@example.com">
                    </div>
                    <button type="submit" class="btn btn-warning">Grant Admin Access</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Approve/Reject Booking Modal -->
    <div id="bookingActionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Booking Action</h2>
                <span class="close" onclick="closeModal('bookingActionModal')">&times;</span>
            </div>
            <div id="modalBookingDetails"></div>
            <div class="form-group" id="rejectReasonGroup" style="display:none;">
                <label>Rejection Reason</label>
                <textarea id="rejectReason" rows="3" placeholder="Optional reason for rejection..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="confirmActionBtn" class="btn btn-success" style="flex: 1;">Confirm</button>
                <button onclick="closeModal('bookingActionModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Block Time Modal -->
    <div id="blockTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Block Time Slot</h2>
                <span class="close" onclick="closeModal('blockTimeModal')">&times;</span>
            </div>
            <form id="blockTimeForm">
                <div class="form-group">
                    <label>Date*</label>
                    <input type="date" id="blockDate" required>
                </div>
                <div class="time-container">
                    <div class="form-group">
                        <label>Start Time*</label>
                        <input type="time" id="blockStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>End Time*</label>
                        <input type="time" id="blockEndTime" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Reason (Optional)</label>
                    <input type="text" id="blockReason" placeholder="e.g., Maintenance, Private event">
                </div>
                <button type="submit" class="btn btn-danger" style="width: 100%;">Block Time</button>
            </form>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loader"></div>
            <div id="loadingMessage">Processing...</div>
        </div>
    </div>

    <!-- Alert Backdrop -->
    <div id="alertBackdrop" class="alert-backdrop"></div>
    
    <!-- Centered Alert -->
    <div id="centeredAlert" class="alert">
        <div id="centeredAlertMessage"></div>
    </div>

    <!-- Confirmation Modals -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmationTitle">Confirm Action</h2>
                <span class="close" onclick="closeModal('confirmationModal')">&times;</span>
            </div>
            <div id="confirmationMessage">Are you sure?</div>
            <div class="form-group" id="reasonGroup" style="display: none; margin-top: 15px;">
                <label for="rejectionReason">Rejection Reason (Optional):</label>
                <textarea id="rejectionReason" placeholder="Enter reason for rejection..." rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="confirmButton" class="btn btn-primary" style="flex: 1;">Confirm</button>
                <button onclick="closeModal('confirmationModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Booking Modal -->
    <div id="editBookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Booking</h2>
                <span class="close" onclick="closeModal('editBookingModal')">&times;</span>
            </div>
            <form id="editBookingForm">
                <div class="form-group">
                    <label for="editDate">Date*</label>
                    <input type="date" id="editDate" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editStartTime">Start Time*</label>
                        <select id="editStartTime" required>
                            <option value="">Select time</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                            <option value="22:00">10:00 PM</option>
                            <option value="23:00">11:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDuration">Duration (hours)*</label>
                        <select id="editDuration" required>
                            <option value="">Select</option>
                            <option value="1">1 hour</option>
                            <option value="2">2 hours</option>
                            <option value="3">3 hours</option>
                            <option value="4">4 hours</option>
                            <option value="5">5 hours</option>
                            <option value="6">6 hours</option>
                            <option value="7">7 hours</option>
                            <option value="8">8 hours</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editRentalType">Rental Type*</label>
                    <input type="text" id="editRentalType" required>
                </div>
                <div class="form-group">
                    <label for="editPrice">Price (‚Çπ)*</label>
                    <input type="number" id="editPrice" required min="0">
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Update Booking</button>
                    <button type="button" onclick="closeModal('editBookingModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUser = null;

        // Utility functions
        const showAlert = (elementId, message, type = 'info') => {
            // Use centered alert system for better UX
            const backdrop = document.getElementById('alertBackdrop');
            const alert = document.getElementById('centeredAlert');
            const messageEl = document.getElementById('centeredAlertMessage');
            
            // Handle multi-line messages by preserving line breaks
            messageEl.innerHTML = message.replace(/\n/g, '<br>');
            alert.className = `alert alert-${type} show`;
            backdrop.classList.add('show');
            
            // Auto-hide after longer time for detailed messages
            const hideDelay = message.length > 200 ? 8000 : 4000;
            setTimeout(() => {
                alert.classList.remove('show');
                backdrop.classList.remove('show');
            }, hideDelay);
            
            // Also allow clicking backdrop to close
            backdrop.onclick = () => {
                alert.classList.remove('show');
                backdrop.classList.remove('show');
            };
        };

        // Loading utility functions
        const showLoading = (message = 'Loading...') => {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = message;
            overlay.classList.add('show');
        };

        const hideLoading = () => {
            document.getElementById('loadingOverlay').classList.remove('show');
        };

        const showButtonLoading = (buttonId, originalText) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('loading');
                button.textContent = '';
                button.setAttribute('data-original-text', originalText);
            }
        };

        const hideButtonLoading = (buttonId) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.remove('loading');
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.textContent = originalText;
                    button.removeAttribute('data-original-text');
                }
            }
        };

        const showSectionLoading = (containerId, message = 'Loading...') => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loader"></div>
                        ${message}
                    </div>
                `;
            }
        };

        // Confirmation modal functions
        const showConfirmationModal = (title, message, confirmText, onConfirm, showReason = false) => {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmButton').textContent = confirmText;
            
            const reasonGroup = document.getElementById('reasonGroup');
            const rejectionReason = document.getElementById('rejectionReason');
            
            if (showReason) {
                reasonGroup.style.display = 'block';
                rejectionReason.value = '';
            } else {
                reasonGroup.style.display = 'none';
            }
            
            document.getElementById('confirmationModal').classList.add('show');
            
            // Remove any existing listeners and add new one
            const confirmButton = document.getElementById('confirmButton');
            const newButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newButton, confirmButton);
            
            newButton.onclick = () => {
                closeModal('confirmationModal');
                onConfirm();
            };
        };

        const formatDate = (dateStr) => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        };

        const formatTime = (time) => {
            if (!time) return 'N/A';
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('show');
        };

        const showBlockTimeModal = () => {
            document.getElementById('blockTimeForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('blockDate').setAttribute('min', today);
            document.getElementById('blockTimeModal').classList.add('show');
        };

        // Authentication
        const checkAuth = async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Not authenticated');

                const data = await res.json();
                currentUser = data.user;
                
                if (currentUser.role !== 'admin') {
                    alert('Admin access required');
                    window.location.href = '/index.html';
                    return;
                }

                document.getElementById('adminName').textContent = `Admin: ${currentUser.name}`;
                await loadStats();
                await loadBookings();
            } catch (error) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        };

        const logout = () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        };

        // Tab switching
        const switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'bookings') loadBookings();
            if (tab === 'calendar') initCalendar();
            if (tab === 'revenue') loadRevenue();
            if (tab === 'blocked') loadBlockedTimes();
            if (tab === 'settings') loadSettings();
        };

        // Load statistics
        const loadStats = async () => {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load stats');

                const data = await res.json();
                document.getElementById('totalBookings').textContent = data.stats.totalBookings;
                document.getElementById('pendingBookings').textContent = data.stats.pendingBookings;
                document.getElementById('confirmedBookings').textContent = data.stats.confirmedBookings;
                document.getElementById('totalRevenue').textContent = `‚Çπ${data.stats.totalRevenue}`;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        };

        // Calendar functionality
        let calendar = null;

        const initCalendar = () => {
            if (calendar) {
                calendar.destroy();
            }

            // Initialize month/year selectors
            const now = new Date();
            const monthSelect = document.getElementById('calendarMonth');
            const yearSelect = document.getElementById('calendarYear');
            
            // Set current month
            monthSelect.value = now.getMonth();
            
            // Populate year options
            yearSelect.innerHTML = '';
            for (let year = now.getFullYear() - 1; year <= now.getFullYear() + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === now.getFullYear()) option.selected = true;
                yearSelect.appendChild(option);
            }

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                eventClick: function(info) {
                    const booking = info.event.extendedProps;
                    const rentalsDisplay = booking.rentals && booking.rentals.length > 0 
                        ? booking.rentals.map(r => `  - ${r.name} √ó ${r.quantity}`).join('\n')
                        : booking.rentalType;
                    alert(`Booking Details:
Name: ${booking.userName}
Email: ${booking.userEmail}
Band: ${booking.bandName || 'N/A'}
Rentals:
${rentalsDisplay}
Price: ‚Çπ${booking.price}
Status: ${booking.status}
Payment: ${booking.paymentStatus}
Notes: ${booking.notes || 'N/A'}`);
                },
                eventDidMount: function(info) {
                    const booking = info.event.extendedProps;
                    const rentalSummary = booking.rentals && booking.rentals.length > 0 
                        ? `${booking.rentals.length} item(s)`
                        : booking.rentalType;
                    info.el.setAttribute('title', `${booking.userName} - ${rentalSummary} (${booking.status})`);
                }
            });

            calendar.render();
            loadCalendar();
        };

        const loadCalendar = async () => {
            try {
                const month = document.getElementById('calendarMonth').value;
                const year = document.getElementById('calendarYear').value;
                
                showSectionLoading('calendar', 'Loading calendar events...');
                
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/bookings/calendar?month=${month}&year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load calendar data');

                const data = await res.json();
                
                // Clear existing events
                calendar.removeAllEvents();
                
                // Add new events
                calendar.addEventSource(data.events);
                
                // Navigate calendar to selected month
                calendar.gotoDate(new Date(parseInt(year), parseInt(month), 1));
                
            } catch (error) {
                console.error('Failed to load calendar:', error);
                showAlert('calendarAlert', 'Failed to load calendar data', 'error');
            }
        };

        // Revenue functionality
        const loadRevenue = async () => {
            try {
                showSectionLoading('revenueTable', 'Loading revenue data...');
                
                const filter = document.getElementById('revenueFilter').value;
                let url = `${API_URL}/api/admin/revenue?filter=${filter}`;
                
                // Handle custom range
                if (filter === 'range') {
                    const startDate = document.getElementById('revenueStartDate').value;
                    const endDate = document.getElementById('revenueEndDate').value;
                    
                    if (!startDate || !endDate) {
                        showAlert('revenueAlert', 'Please select both start and end dates for custom range', 'error');
                        return;
                    }
                    
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                }

                const token = localStorage.getItem('token');
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load revenue data');

                const data = await res.json();
                
                // Update summary cards
                document.getElementById('revenueTotal').textContent = `‚Çπ${data.revenue.totalRevenue}`;
                document.getElementById('revenueBookings').textContent = data.revenue.totalBookings;
                document.getElementById('revenueAvg').textContent = `‚Çπ${data.revenue.avgBookingValue}`;
                
                // Update revenue by type
                updateRevenueCharts(data.revenue);
                
                // Update revenue table
                updateRevenueTable(data.bookings);
                
            } catch (error) {
                console.error('Failed to load revenue:', error);
                showAlert('revenueAlert', 'Failed to load revenue data', 'error');
            }
        };

        const updateRevenueCharts = (revenue) => {
            // Revenue by type
            const revenueByTypeHtml = Object.entries(revenue.revenueByType)
                .sort(([,a], [,b]) => b - a)
                .map(([type, amount]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${type}</span>
                        <strong>‚Çπ${amount}</strong>
                    </div>
                `).join('') || '<p style="text-align: center; color: #666;">No data available</p>';
            
            document.getElementById('revenueByType').innerHTML = revenueByTypeHtml;
            
            // Bookings by type
            const bookingsByTypeHtml = Object.entries(revenue.bookingsByType)
                .sort(([,a], [,b]) => b - a)
                .map(([type, count]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${type}</span>
                        <strong>${count} booking${count !== 1 ? 's' : ''}</strong>
                    </div>
                `).join('') || '<p style="text-align: center; color: #666;">No data available</p>';
                
            document.getElementById('bookingsByType').innerHTML = bookingsByTypeHtml;
        };

        const updateRevenueTable = (bookings) => {
            if (bookings.length === 0) {
                document.getElementById('revenueTable').innerHTML = '<p style="text-align: center; color: #666;">No bookings found for the selected period</p>';
                return;
            }

            const tableHtml = `
                <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Type</th>
                            <th>Band</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(booking => `
                            <tr>
                                <td>${formatDate(booking.date)}</td>
                                <td>${booking.userName}<br><small>${booking.userEmail}</small></td>
                                <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                                <td>${booking.duration}h</td>
                                <td>
                                    ${booking.rentals && booking.rentals.length > 0 ? 
                                        booking.rentals.map(r => `${r.name} √ó ${r.quantity}`).join('<br>') :
                                        booking.rentalType
                                    }
                                </td>
                                <td>${booking.bandName || 'N/A'}</td>
                                <td>
                                    <strong>‚Çπ${booking.price}</strong>
                                    ${booking.subtotal !== undefined && booking.taxAmount !== undefined ? 
                                        `<br><small>Subtotal: ‚Çπ${booking.subtotal}<br>Tax: ‚Çπ${booking.taxAmount}</small>` : ''
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                </div>
            `;
            
            document.getElementById('revenueTable').innerHTML = tableHtml;
        };

        // Show/hide custom range inputs
        document.addEventListener('DOMContentLoaded', () => {
            const revenueFilter = document.getElementById('revenueFilter');
            if (revenueFilter) {
                revenueFilter.addEventListener('change', (e) => {
                    const customRangeInputs = document.getElementById('customRangeInputs');
                    if (e.target.value === 'range') {
                        customRangeInputs.style.display = 'block';
                    } else {
                        customRangeInputs.style.display = 'none';
                        if (e.target.value !== 'range') {
                            loadRevenue();
                        }
                    }
                });
            }
        });

        // Load bookings
        const loadBookings = async () => {
            try {
                showSectionLoading('bookingsTable', 'Loading bookings...');
                
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/bookings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load bookings');

                const data = await res.json();
                
                document.getElementById('bookingsLoading').style.display = 'none';
                
                if (data.bookings.length === 0) {
                    document.getElementById('bookingsTable').innerHTML = 
                        '<p style="text-align:center; padding: 20px; color:#666;">No bookings found</p>';
                    return;
                }

                // Sort bookings by creation date (newest first)
                const sortedBookings = data.bookings.sort((a, b) => {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                let html = '<div class="table-container"><table><thead><tr><th>#</th><th>User</th><th>Date</th><th>Time</th><th>Duration</th><th>Type</th><th>Price</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                
                let serialNo = 1;
                sortedBookings.forEach(booking => {
                    // Skip old bookings that don't have the new schema
                    if (!booking.startTime || !booking.endTime || !booking.duration) {
                        console.log('Skipping old booking:', booking._id);
                        return;
                    }
                    
                    const statusClass = booking.bookingStatus.toLowerCase();
                    const userName = booking.userId?.name || booking.userName || 'N/A';
                    const userEmail = booking.userId?.email || booking.userEmail || 'N/A';
                    const createdDate = booking.createdAt ? new Date(booking.createdAt).toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'N/A';
                    
                    html += `
                        <tr>
                            <td style="font-weight: bold; text-align: center;">${serialNo++}</td>
                            <td>${userName}<br><small>${userEmail}</small></td>
                            <td>${formatDate(booking.date)}</td>
                            <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                            <td>${booking.duration} hour(s)</td>
                            <td>
                                ${booking.rentals && booking.rentals.length > 0 ? 
                                    booking.rentals.map(r => `${r.name} √ó ${r.quantity}`).join('<br>') :
                                    booking.rentalType
                                }
                            </td>
                            <td>
                                ‚Çπ${booking.price}
                                ${booking.subtotal !== undefined && booking.taxAmount !== undefined ? 
                                    `<br><small>Subtotal: ‚Çπ${booking.subtotal}<br>Tax: ‚Çπ${booking.taxAmount}</small>` : ''
                                }
                            </td>
                            <td><span class="status-badge status-${statusClass}">${booking.bookingStatus}</span></td>
                            <td><small>${createdDate}</small></td>
                            <td>
                                ${booking.bookingStatus === 'PENDING' ? `
                                    <button onclick="approveBooking('${booking._id}')" class="btn btn-success btn-sm">Approve</button>
                                    <button onclick="rejectBooking('${booking._id}')" class="btn btn-danger btn-sm">Reject</button>
                                ` : ''}
                                ${booking.bookingStatus === 'CONFIRMED' ? `
                                    <button onclick="sendEBill('${booking._id}')" class="btn btn-primary btn-sm" title="Send eBill to Customer">üìß Send eBill</button>
                                    <button onclick="downloadPDF('${booking._id}')" class="btn btn-secondary btn-sm" title="Download PDF Bill">üìÑ Download PDF</button>
                                ` : ''}
                                <button onclick="editBooking('${booking._id}', ${JSON.stringify(booking).replace(/"/g, '&quot;')})" class="btn btn-warning btn-sm">Edit</button>
                                <button onclick="deleteBooking('${booking._id}')" class="btn btn-danger btn-sm">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                document.getElementById('bookingsTable').innerHTML = html;
            } catch (error) {
                console.error('Load bookings error:', error);
                document.getElementById('bookingsTable').innerHTML = 
                    '<p style="color: #dc3545;">Failed to load bookings: ' + error.message + '</p>';
            }
        };

        // Approve booking
        const approveBooking = async (bookingId) => {
            showConfirmationModal(
                'Approve Booking',
                'Are you sure you want to approve this booking? This will confirm the reservation and send a notification to the customer.',
                'Approve',
                async () => {
                    try {
                        showLoading('Approving booking...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}/approve`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!res.ok) throw new Error('Failed to approve booking');

                        showAlert('bookingAlert', 'Booking approved successfully!', 'success');
                        await loadStats();
                        await loadBookings();
                    } catch (error) {
                        console.error('Approve booking error:', error);
                        
                        // Improve error messages for common email issues
                        let userMessage = error.message;
                        
                        if (error.message.includes('Daily user sending limit exceeded')) {
                            userMessage = 'üìß Gmail Daily Limit Reached!\n\n' +
                                'Booking was approved but notification email failed due to Gmail\'s daily sending limit.\n\n' +
                                'Solutions:\n' +
                                '‚Ä¢ Manually inform the customer about approval\n' +
                                '‚Ä¢ Wait 24 hours for limit reset\n' +
                                '‚Ä¢ Use "Send eBill" later to send confirmation\n\n' +
                                'The booking is still successfully approved!';
                        } else if (error.message.includes('Authentication failed') || error.message.includes('invalid credentials')) {
                            userMessage = '‚úÖ Booking Approved! üîê Email Setup Issue\n\n' +
                                'Booking was approved but notification failed due to email configuration.\n\n' +
                                'Check:\n' +
                                '‚Ä¢ EMAIL_USER and EMAIL_PASS in .env file\n' +
                                '‚Ä¢ Gmail App Password validity\n' +
                                '‚Ä¢ 2-Factor Authentication enabled';
                        }
                        
                        showAlert('bookingAlert', userMessage, error.message.includes('Daily user sending limit') || error.message.includes('Authentication') ? 'warning' : 'error');
                    } finally {
                        hideLoading();
                    }
                }
            );
        };

        // Reject booking
        const rejectBooking = async (bookingId) => {
            showConfirmationModal(
                'Reject Booking',
                'Are you sure you want to reject this booking? This will notify the customer that their booking has been declined.',
                'Reject',
                async () => {
                    const reason = document.getElementById('rejectionReason').value.trim();
                    
                    try {
                        showLoading('Rejecting booking...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}/reject`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ reason: reason || undefined })
                        });

                        if (!res.ok) throw new Error('Failed to reject booking');

                        showAlert('bookingAlert', 'Booking rejected', 'info');
                        await loadStats();
                        await loadBookings();
                    } catch (error) {
                        console.error('Reject booking error:', error);
                        
                        // Improve error messages for common email issues
                        let userMessage = error.message;
                        
                        if (error.message.includes('Daily user sending limit exceeded')) {
                            userMessage = 'üìß Gmail Daily Limit Reached!\n\n' +
                                'Booking was rejected but notification email failed due to Gmail\'s daily sending limit.\n\n' +
                                'Solutions:\n' +
                                '‚Ä¢ Manually inform the customer about rejection\n' +
                                '‚Ä¢ Wait 24 hours for limit reset\n' +
                                '‚Ä¢ Call customer directly if urgent\n\n' +
                                'The booking is still successfully rejected!';
                        } else if (error.message.includes('Authentication failed') || error.message.includes('invalid credentials')) {
                            userMessage = '‚úÖ Booking Rejected! üîê Email Setup Issue\n\n' +
                                'Booking was rejected but notification failed due to email configuration.\n\n' +
                                'Check:\n' +
                                '‚Ä¢ EMAIL_USER and EMAIL_PASS in .env file\n' +
                                '‚Ä¢ Gmail App Password validity\n' +
                                '‚Ä¢ 2-Factor Authentication enabled';
                        }
                        
                        showAlert('bookingAlert', userMessage, error.message.includes('Daily user sending limit') || error.message.includes('Authentication') ? 'warning' : 'error');
                    } finally {
                        hideLoading();
                    }
                },
                true // Show reason input
            );
        };

        // Edit booking
        let currentEditingBookingId = null;
        
        const editBooking = (bookingId, bookingData) => {
            try {
                currentEditingBookingId = bookingId;
                
                // Parse booking data if it's a string
                const booking = typeof bookingData === 'string' ? JSON.parse(bookingData.replace(/&quot;/g, '"')) : bookingData;
                
                // Format date for input (YYYY-MM-DD)
                const bookingDate = new Date(booking.date);
                const formattedDate = bookingDate.toISOString().split('T')[0];
                
                // Calculate end time from start time and duration
                const calculateEndTime = (startTime, duration) => {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + (duration * 60);
                    const endHours = Math.floor(totalMinutes / 60) % 24;
                    const endMins = totalMinutes % 60;
                    return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                };
                
                // Populate form fields
                document.getElementById('editDate').value = formattedDate;
                document.getElementById('editStartTime').value = booking.startTime;
                document.getElementById('editDuration').value = booking.duration;
                document.getElementById('editRentalType').value = booking.rentalType;
                document.getElementById('editPrice').value = booking.price;
                document.getElementById('editNotes').value = booking.notes || '';
                
                // Show modal
                document.getElementById('editBookingModal').style.display = 'block';
            } catch (error) {
                console.error('Error opening edit modal:', error);
                showAlert('bookingAlert', 'Error opening edit form', 'error');
            }
        };

        // Delete booking
        const deleteBooking = (bookingId) => {
            showConfirmationModal(
                'Delete Booking',
                'Are you sure you want to delete this booking? This action cannot be undone and will notify the customer.',
                'Delete',
                async () => {
                    try {
                        showLoading('Deleting booking...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!res.ok) throw new Error('Failed to delete booking');

                        showAlert('bookingAlert', 'Booking deleted successfully', 'success');
                        await loadStats();
                        await loadBookings();
                    } catch (error) {
                        showAlert('bookingAlert', error.message, 'error');
                    } finally {
                        hideLoading();
                    }
                }
            );
        };

        // Send eBill to customer
        const sendEBill = async (bookingId) => {
            showConfirmationModal(
                'Send eBill',
                'This will generate and send an electronic bill to the customer via email. The bill will include all booking details, pricing, and payment information.',
                'Send eBill',
                async () => {
                    try {
                        showLoading('Generating and sending eBill...');
                        
                        const token = localStorage.getItem('token');
                        const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}/send-ebill`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!res.ok) {
                            const error = await res.json();
                            throw new Error(error.message || 'Failed to send eBill');
                        }

                        const result = await res.json();
                        showAlert('bookingAlert', result.message || 'eBill sent successfully to customer!', 'success');
                    } catch (error) {
                        console.error('Send eBill error:', error);
                        
                        // Improve error messages for common Gmail issues
                        let userMessage = error.message;
                        
                        if (error.message.includes('Daily user sending limit exceeded')) {
                            userMessage = 'üìß Gmail Daily Limit Reached!\n\n' +
                                'You\'ve exceeded Gmail\'s daily sending limit. This typically resets within 24 hours.\n\n' +
                                'Solutions:\n' +
                                '‚Ä¢ Wait 24 hours and try again\n' +
                                '‚Ä¢ Use a different Gmail account\n' +
                                '‚Ä¢ Consider upgrading to Google Workspace for higher limits\n\n' +
                                'Learn more: https://support.google.com/a/answer/166852';
                        } else if (error.message.includes('Authentication failed') || error.message.includes('invalid credentials')) {
                            userMessage = 'üîê Gmail Authentication Issue!\n\n' +
                                'Your Gmail credentials may be invalid or expired.\n\n' +
                                'Solutions:\n' +
                                '‚Ä¢ Check EMAIL_USER and EMAIL_PASS in .env file\n' +
                                '‚Ä¢ Regenerate Gmail App Password\n' +
                                '‚Ä¢ Ensure 2-Factor Authentication is enabled\n\n' +
                                'Setup Guide: https://support.google.com/mail/answer/185833';
                        } else if (error.message.includes('Recipient address rejected') || error.message.includes('Invalid recipients')) {
                            userMessage = 'üìÆ Invalid Email Address!\n\n' +
                                'The customer\'s email address appears to be invalid.\n\n' +
                                'Solutions:\n' +
                                '‚Ä¢ Verify the email address in booking details\n' +
                                '‚Ä¢ Contact customer for correct email\n' +
                                '‚Ä¢ Edit booking with valid email address';
                        } else if (error.message.includes('Network')) {
                            userMessage = 'üåê Network Connection Issue!\n\n' +
                                'Unable to connect to Gmail servers.\n\n' +
                                'Solutions:\n' +
                                '‚Ä¢ Check your internet connection\n' +
                                '‚Ä¢ Try again in a few minutes\n' +
                                '‚Ä¢ Verify firewall settings';
                        }
                        
                        showAlert('bookingAlert', userMessage, 'error');
                    } finally {
                        hideLoading();
                    }
                }
            );
        };

        // Download PDF bill
        const downloadPDF = async (bookingId) => {
            try {
                showLoading('Generating PDF bill...');
                
                const token = localStorage.getItem('token');
                
                // First, try server-side PDF generation
                try {
                    console.log('Attempting server-side PDF generation...');
                    const res = await fetch(`${API_URL}/api/admin/bookings/${bookingId}/download-pdf`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        // Server-side generation successful
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `jamroom-bill-${bookingId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        showAlert('bookingAlert', 'PDF bill downloaded successfully!', 'success');
                        return; // Success, exit early
                    } else {
                        const error = await res.json();
                        console.log('Server-side PDF failed:', error.message);
                        throw new Error(error.message || 'Server-side PDF generation failed');
                    }
                } catch (serverError) {
                    console.log('Server-side PDF generation failed, trying client-side...', serverError.message);
                    
                    // Fallback to client-side PDF generation
                    showLoading('Server unavailable, generating PDF locally...');
                    
                    // Get booking data and admin settings for client-side generation
                    const [bookingRes, settingsRes] = await Promise.all([
                        fetch(`${API_URL}/api/bookings/${bookingId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        fetch(`${API_URL}/api/admin/debug-settings`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    ]);
                    
                    if (!bookingRes.ok) {
                        throw new Error('Could not fetch booking data for PDF generation');
                    }
                    
                    const bookingData = await bookingRes.json();
                    let settingsData = null;
                    
                    if (settingsRes.ok) {
                        const settings = await settingsRes.json();
                        settingsData = settings.settings;
                    }
                    
                    // Generate PDF on client-side
                    await generatePDFClient(bookingData.booking, settingsData);
                    showAlert('bookingAlert', 'PDF bill downloaded successfully! (Generated locally)', 'success');
                }
                
            } catch (error) {
                console.error('Download PDF error:', error);
                
                // Improve error messages
                let userMessage = error.message;
                
                if (error.message.includes('Booking not found')) {
                    userMessage = '‚ùå Booking Not Found!\n\nThe booking may have been deleted or the ID is invalid.\n\nTry refreshing the page and locating the booking again.';
                } else if (error.message.includes('PDF generation failed')) {
                    userMessage = 'üìÑ PDF Generation Failed!\n\nThere was an issue creating the PDF document.\n\nSolutions:\n‚Ä¢ Try again in a few moments\n‚Ä¢ Check if all booking data is complete\n‚Ä¢ Contact support if the issue persists';
                } else if (error.message.includes('generatePDFClient is not defined')) {
                    userMessage = 'PDF generation library not loaded. Please refresh the page and try again.';
                } else {
                    userMessage = 'Unable to generate PDF. Please try again or contact support if the problem persists.';
                }
                
                showAlert('bookingAlert', userMessage, 'error');
            } finally {
                hideLoading();
            }
        };

        // Load blocked times
        const loadBlockedTimes = async () => {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/blocked-times`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load blocked times');

                const data = await res.json();
                
                document.getElementById('blockedLoading').style.display = 'none';
                
                if (data.blockedTimes.length === 0) {
                    document.getElementById('blockedList').innerHTML = 
                        '<p style="text-align:center; padding: 20px; color:#666;">No blocked times</p>';
                    return;
                }

                let html = '';
                data.blockedTimes.forEach(blocked => {
                    html += `
                        <div class="blocked-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>${formatDate(blocked.date)}</h4>
                                    <p><strong>Time:</strong> ${formatTime(blocked.startTime)} - ${formatTime(blocked.endTime)}</p>
                                    <p><strong>Reason:</strong> ${blocked.reason}</p>
                                    <small>Blocked by: ${blocked.blockedBy.name}</small>
                                </div>
                                <button onclick="unblockTime('${blocked._id}')" class="btn btn-danger btn-sm">Unblock</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('blockedList').innerHTML = html;
            } catch (error) {
                document.getElementById('blockedList').innerHTML = 
                    '<p style="color: #dc3545;">Failed to load blocked times</p>';
            }
        };

        // Edit booking form handler
        document.getElementById('editBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditingBookingId) {
                showAlert('bookingAlert', 'No booking selected for editing', 'error');
                return;
            }

            try {
                showLoading('Updating booking...');

                const formData = {
                    date: document.getElementById('editDate').value,
                    startTime: document.getElementById('editStartTime').value,
                    duration: parseInt(document.getElementById('editDuration').value),
                    rentalType: document.getElementById('editRentalType').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    notes: document.getElementById('editNotes').value
                };

                // Calculate end time
                const calculateEndTime = (startTime, duration) => {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + (duration * 60);
                    const endHours = Math.floor(totalMinutes / 60) % 24;
                    const endMins = totalMinutes % 60;
                    return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                };

                formData.endTime = calculateEndTime(formData.startTime, formData.duration);

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/bookings/${currentEditingBookingId}/edit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Failed to update booking');
                }

                closeModal('editBookingModal');
                showAlert('bookingAlert', 'Booking updated successfully!', 'success');
                await loadStats();
                await loadBookings();
                currentEditingBookingId = null;

            } catch (error) {
                showAlert('bookingAlert', error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Block time
        document.getElementById('blockTimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                date: document.getElementById('blockDate').value,
                startTime: document.getElementById('blockStartTime').value,
                endTime: document.getElementById('blockEndTime').value,
                reason: document.getElementById('blockReason').value
            };

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/block-time`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Failed to block time');
                }

                showAlert('blockedAlert', 'Time blocked successfully!', 'success');
                closeModal('blockTimeModal');
                await loadBlockedTimes();
            } catch (error) {
                showAlert('blockedAlert', error.message, 'error');
            }
        });

        // Unblock time
        const unblockTime = async (blockedId) => {
            if (!confirm('Remove this blocked time?')) return;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/blocked-times/${blockedId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to unblock time');

                showAlert('blockedAlert', 'Time unblocked successfully!', 'success');
                await loadBlockedTimes();
            } catch (error) {
                showAlert('blockedAlert', error.message, 'error');
            }
        };

        // Load settings
        const loadSettings = async () => {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load settings');

                const data = await res.json();
                const settings = data.settings;

                document.getElementById('studioName').value = settings.studioName || 'JamRoom Studio';
                document.getElementById('studioAddress').value = settings.studioAddress || '';
                document.getElementById('upiId').value = settings.upiId;
                document.getElementById('upiName').value = settings.upiName;
                document.getElementById('adminEmails').value = settings.adminEmails.join(', ');
                
                // Load GST configuration
                const gstEnabled = document.getElementById('gstEnabled');
                const gstRate = document.getElementById('gstRate');
                const gstDisplayName = document.getElementById('gstDisplayName');
                const gstDetails = document.getElementById('gstDetails');
                
                if (settings.gstConfig) {
                    gstEnabled.checked = settings.gstConfig.enabled || false;
                    gstRate.value = (settings.gstConfig.rate || 0.18) * 100; // Convert to percentage
                    gstDisplayName.value = settings.gstConfig.displayName || 'GST';
                } else {
                    // Default values
                    gstEnabled.checked = false;
                    gstRate.value = 18;
                    gstDisplayName.value = 'GST';
                }
                
                // Show/hide GST details based on enabled state
                gstDetails.style.display = gstEnabled.checked ? 'block' : 'none';
                
                // Load rental types
                loadRentalTypes(settings.rentalTypes || []);
            } catch (error) {
                showAlert('settingsAlert', 'Failed to load settings', 'error');
            }
        };

        // Save settings
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rentalTypes = getCurrentRentalTypes();
            
            // Check for validation errors
            if (rentalTypes === null) {
                // Validation failed, getCurrentRentalTypes() returned null
                return;
            }

            const formData = {
                studioName: document.getElementById('studioName').value,
                studioAddress: document.getElementById('studioAddress').value,
                upiId: document.getElementById('upiId').value,
                upiName: document.getElementById('upiName').value,
                adminEmails: document.getElementById('adminEmails').value.split(',').map(e => e.trim()).filter(e => e),
                rentalTypes: rentalTypes,
                gstConfig: {
                    enabled: document.getElementById('gstEnabled').checked,
                    rate: parseFloat(document.getElementById('gstRate').value) / 100 || 0.18, // Convert percentage to decimal
                    displayName: document.getElementById('gstDisplayName').value || 'GST'
                }
            };

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!res.ok) throw new Error('Failed to save settings');

                showAlert('settingsAlert', 'Settings saved successfully!', 'success');
            } catch (error) {
                showAlert('settingsAlert', error.message, 'error');
            }
        });

        // GST Configuration Toggle
        document.getElementById('gstEnabled').addEventListener('change', function() {
            const gstDetails = document.getElementById('gstDetails');
            gstDetails.style.display = this.checked ? 'block' : 'none';
        });

        // Make admin
        document.getElementById('makeAdminForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('userEmail').value;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/admin/make-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Failed to grant admin access');
                }

                showAlert('userAlert', `Admin access granted to ${email}`, 'success');
                document.getElementById('makeAdminForm').reset();
            } catch (error) {
                showAlert('userAlert', error.message, 'error');
            }
        });

        // Rental Types Management Functions
        function loadRentalTypes(rentalTypes = []) {
            const container = document.getElementById('rentalTypesContainer');
            container.innerHTML = '';
            
            rentalTypes.forEach((rental, index) => {
                const hasSubItems = rental.subItems && rental.subItems.length > 0;
                const subItemsHTML = hasSubItems ? rental.subItems.map((sub, subIndex) => {
                    const isPerday = (sub.rentalType || 'inhouse') === 'perday';
                    return `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 4px;" data-rental="${index}">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">Item Name</label>
                            <input type="text" value="${sub.name || ''}" data-rental="${index}" data-subitem="${subIndex}" data-field="name"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">Description</label>
                            <input type="text" value="${sub.description || ''}" data-rental="${index}" data-subitem="${subIndex}" data-field="description"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="Optional">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">Rental Type</label>
                            <select data-rental="${index}" data-subitem="${subIndex}" data-field="rentalType" onchange="togglePerdayPrice(${index}, ${subIndex})"
                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                <option value="inhouse" ${(sub.rentalType || 'inhouse') === 'inhouse' ? 'selected' : ''}>In-house</option>
                                <option value="perday" ${(sub.rentalType || 'inhouse') === 'perday' ? 'selected' : ''}>Per-day</option>
                            </select>
                        </div>
                        <div class="hourly-price-field">
                            <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">
                                Price (‚Çπ/hr) ${isPerday ? '<span style="color: #dc3545; font-size: 10px;">(not used for per-day)</span>' : '<span style="color: #28a745; font-size: 10px;">(active)</span>'}
                            </label>
                            <input type="number" value="${sub.price || ''}" data-rental="${index}" data-subitem="${subIndex}" data-field="price"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; ${isPerday ? 'background-color: #f8f9fa; color: #6c757d;' : ''}" min="0" ${isPerday ? 'placeholder="Not used"' : ''}>
                        </div>
                        <div class="perday-price-field" style="display: ${isPerday ? 'block' : 'none'};">
                            <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">
                                Per-day Price (‚Çπ/day) <span style="color: #28a745; font-size: 10px;">(active for per-day rentals)</span>
                            </label>
                            <input type="number" value="${sub.perdayPrice || ''}" data-rental="${index}" data-subitem="${subIndex}" data-field="perdayPrice"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background-color: #e8f5e8;" min="0" placeholder="Required for per-day">
                        </div>
                        <button type="button" onclick="removeSubItem(${index}, ${subIndex})" 
                                style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">√ó</button>
                    </div>
                    `;
                }).join('') : '';

                const rentalDiv = document.createElement('div');
                rentalDiv.style.cssText = 'border: 2px solid #e1e8ed; padding: 20px; margin-bottom: 15px; border-radius: 8px; background: #f8f9fa;';
                rentalDiv.dataset.rentalIndex = index;
                rentalDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Category Name*</label>
                            <input type="text" value="${rental.name || ''}" onchange="updateRentalType(${index}, 'name', this.value)" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                   placeholder="e.g., Synths, Guitars, JamRoom">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Base Price (‚Çπ/hr)* <small style="color:#6c757d;">(used if no sub-items)</small></label>
                            <input type="number" value="${rental.basePrice || ''}" onchange="updateRentalType(${index}, 'basePrice', parseInt(this.value))" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" min="0">
                        </div>
                        <button type="button" onclick="removeRentalType(${index})" 
                                style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Remove</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Description</label>
                        <textarea onchange="updateRentalType(${index}, 'description', this.value)" 
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;" 
                                  rows="2" placeholder="Optional description">${rental.description || ''}</textarea>
                    </div>
                    
                    <!-- Sub-items Section -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="font-weight: 600; color: #667eea; font-size: 14px;">üé∏ Individual Items (Optional)</label>
                            <button type="button" onclick="addSubItem(${index})" 
                                    style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Add Item</button>
                        </div>
                        <p style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">Add individual items with different prices (e.g., Moog Synth - ‚Çπ500/hr, Roland Synth - ‚Çπ400/hr)</p>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #2196f3;">
                            <p style="font-size: 11px; color: #1565c0; margin: 0; font-weight: 500;">üí° Rental Types:</p>
                            <p style="font-size: 11px; color: #1976d2; margin: 2px 0 0 0; line-height: 1.3;">
                                <strong>üîó In-house:</strong> Tied to jam session duration (e.g., guitar for 2-hour session = ‚Çπ200 √ó 2 = ‚Çπ400)<br>
                                <strong>üìÖ Per-day:</strong> Flat daily rate regardless of session length (e.g., guitar for any session = ‚Çπ800/day)
                            </p>
                        </div>
                        <div class="sub-items-container" data-rental="${index}">
                            ${subItemsHTML || '<p style="text-align: center; color: #aaa; font-size: 13px; padding: 10px;">No individual items. Users will see the base price above.</p>'}
                        </div>
                    </div>
                `;
                container.appendChild(rentalDiv);
            });
        }
        
        function addSubItem(rentalIndex) {
            const subItemsContainer = document.querySelector(`.sub-items-container[data-rental="${rentalIndex}"]`);
            if (!subItemsContainer) return;
            
            // Remove "No individual items" message if it exists
            const noItemsMessage = subItemsContainer.querySelector('p');
            if (noItemsMessage && noItemsMessage.textContent.includes('No individual items')) {
                noItemsMessage.remove();
            }
            
            // Find the current number of sub-items in this container
            const existingSubItems = subItemsContainer.querySelectorAll('div[data-rental]');
            const subIndex = existingSubItems.length;
            
            // Create new sub-item div
            const newSubItem = document.createElement('div');
            newSubItem.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 4px;';
            newSubItem.setAttribute('data-rental', rentalIndex);
            newSubItem.innerHTML = `
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">Item Name</label>
                    <input type="text" value="" data-rental="${rentalIndex}" data-subitem="${subIndex}" data-field="name"
                           style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">Description</label>
                    <input type="text" value="" data-rental="${rentalIndex}" data-subitem="${subIndex}" data-field="description"
                           style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="Optional">
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">Rental Type</label>
                    <select data-rental="${rentalIndex}" data-subitem="${subIndex}" data-field="rentalType" onchange="togglePerdayPrice(${rentalIndex}, ${subIndex})"
                            style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        <option value="inhouse" selected>In-house</option>
                        <option value="perday">Per-day</option>
                    </select>
                </div>
                <div class="hourly-price-field">
                    <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">
                        Price (‚Çπ/hr) <span style="color: #28a745; font-size: 10px;">(active)</span>
                    </label>
                    <input type="number" value="" data-rental="${rentalIndex}" data-subitem="${subIndex}" data-field="price"
                           style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" min="0">
                </div>
                <div class="perday-price-field" style="display: none;">
                    <label style="display: block; font-weight: 500; margin-bottom: 3px; color: #6c757d; font-size: 12px;">
                        Per-day Price (‚Çπ/day) <span style="color: #28a745; font-size: 10px;">(active for per-day rentals)</span>
                    </label>
                    <input type="number" value="" data-rental="${rentalIndex}" data-subitem="${subIndex}" data-field="perdayPrice"
                           style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background-color: #e8f5e8;" min="0" placeholder="Required for per-day">
                </div>
                <button type="button" onclick="removeSubItem(${rentalIndex}, ${subIndex})" 
                        style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">√ó</button>`;
            
            subItemsContainer.appendChild(newSubItem);
        }
        
        function removeSubItem(rentalIndex, subItemIndex) {
            // Instead of re-rendering everything, just remove the specific sub-item and re-index
            const currentData = getCurrentRentalTypes();
            if (currentData[rentalIndex].subItems) {
                currentData[rentalIndex].subItems.splice(subItemIndex, 1);
            }
            loadRentalTypes(currentData);
        }
        
        function togglePerdayPrice(rentalIndex, subItemIndex) {
            const selector = `[data-rental="${rentalIndex}"][data-subitem="${subItemIndex}"][data-field="rentalType"]`;
            const rentalTypeSelect = document.querySelector(selector);
            const perdayPriceField = rentalTypeSelect.closest('div').parentElement.querySelector('.perday-price-field');
            const hourlyPriceField = rentalTypeSelect.closest('div').parentElement.querySelector('.hourly-price-field');
            const hourlyPriceInput = hourlyPriceField?.querySelector('input[data-field="price"]');
            const hourlyPriceLabel = hourlyPriceField?.querySelector('label');
            
            if (rentalTypeSelect && perdayPriceField && hourlyPriceField) {
                if (rentalTypeSelect.value === 'perday') {
                    // Show per-day field, grey out hourly field
                    perdayPriceField.style.display = 'block';
                    if (hourlyPriceInput) {
                        hourlyPriceInput.style.backgroundColor = '#f8f9fa';
                        hourlyPriceInput.style.color = '#6c757d';
                        hourlyPriceInput.placeholder = 'Not used';
                    }
                    if (hourlyPriceLabel) {
                        hourlyPriceLabel.innerHTML = 'Price (‚Çπ/hr) <span style="color: #dc3545; font-size: 10px;">(not used for per-day)</span>';
                    }
                } else {
                    // Hide per-day field, activate hourly field
                    perdayPriceField.style.display = 'none';
                    if (hourlyPriceInput) {
                        hourlyPriceInput.style.backgroundColor = '';
                        hourlyPriceInput.style.color = '';
                        hourlyPriceInput.placeholder = '';
                    }
                    if (hourlyPriceLabel) {
                        hourlyPriceLabel.innerHTML = 'Price (‚Çπ/hr) <span style="color: #28a745; font-size: 10px;">(active)</span>';
                    }
                }
            }
        }
        
        function addRentalType() {
            const currentData = getCurrentRentalTypes();
            currentData.push({
                name: '',
                basePrice: 0,
                description: '',
                subItems: []
            });
            loadRentalTypes(currentData);
        }
        
        function removeRentalType(index) {
            const container = document.getElementById('rentalTypesContainer');
            if (container.children[index]) {
                container.removeChild(container.children[index]);
                // Refresh the display to update indices
                const currentData = getCurrentRentalTypes();
                loadRentalTypes(currentData);
            }
        }
        
        function updateRentalType(index, field, value) {
            // This function is called when individual fields are updated
            // The actual data collection happens in getCurrentRentalTypes()
        }
        
        function getCurrentRentalTypes() {
            const container = document.getElementById('rentalTypesContainer');
            const rentalTypes = [];
            
            Array.from(container.children).forEach((div, index) => {
                // Get main rental type fields
                const nameInput = div.querySelector('input[type="text"]');
                const priceInput = div.querySelector('input[type="number"]');
                const descInput = div.querySelector('textarea');
                
                const name = nameInput?.value?.trim();
                const basePrice = parseInt(priceInput?.value) || 0;
                const description = descInput?.value?.trim();
                
                // Get sub-items
                const subItemsContainer = div.querySelector('.sub-items-container');
                const subItems = [];
                
                if (subItemsContainer) {
                    const subItemDivs = subItemsContainer.querySelectorAll('div[data-rental]');
                    subItemDivs.forEach((subDiv) => {
                        const subNameInput = subDiv.querySelector('input[data-field="name"]');
                        const subDescInput = subDiv.querySelector('input[data-field="description"]');
                        const subPriceInput = subDiv.querySelector('input[data-field="price"]');
                        const subRentalTypeSelect = subDiv.querySelector('select[data-field="rentalType"]');
                        const subPerdayPriceInput = subDiv.querySelector('input[data-field="perdayPrice"]');
                        
                        const subName = subNameInput?.value?.trim() || '';
                        const subDesc = subDescInput?.value?.trim() || '';
                        const subPrice = parseInt(subPriceInput?.value) || 0;
                        const subRentalType = subRentalTypeSelect?.value || 'inhouse';
                        const subPerdayPrice = parseInt(subPerdayPriceInput?.value) || 0;
                        
                        // Only save sub-items that have at least a name
                        if (subName) {
                            const subItem = {
                                name: subName,
                                description: subDesc,
                                price: subPrice,
                                rentalType: subRentalType
                            };
                            
                            // Add per-day price only for perday rentals
                            if (subRentalType === 'perday') {
                                subItem.perdayPrice = subPerdayPrice;
                                // Validate per-day price
                                if (!subPerdayPrice || subPerdayPrice <= 0) {
                                    alert(`‚ö†Ô∏è Per-day item "${subName}" must have a per-day price greater than 0`);
                                    return null; // Stop form submission
                                }
                            } else {
                                // For in-house items, allow price of 0 (free items like mics, jacks)
                                // but warn if price is 0
                                if (subPrice === 0) {
                                    console.log(`‚ÑπÔ∏è In-house item "${subName}" has price ‚Çπ0 (free item)`);
                                }
                            }
                            
                            subItems.push(subItem);
                        }
                    });
                }
                
                if (name && basePrice >= 0) {
                    const rental = {
                        name,
                        basePrice,
                        description: description || ''
                    };
                    
                    // Only add subItems if there are valid ones
                    if (subItems.length > 0) {
                        rental.subItems = subItems;
                    }
                    
                    rentalTypes.push(rental);
                }
            });
            
            return rentalTypes;
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
